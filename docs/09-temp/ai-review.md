# ðŸ” Code Review - 11/9/2025, 3:41:57 PM

**Project:** AI Visual Code Review
**Generated by:** AI Visual Code Review v2.0

## ðŸ“Š Change Summary

```
AI_REVIEW.md | 1560 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++-
 script.js    |   80 ++-
 2 files changed, 1568 insertions(+), 72 deletions(-)
```

## ðŸ“ Files Changed (2/2 selected)


### ðŸ“„ `AI_REVIEW.md`

**Type:** Documentation ðŸ“–

```diff
@@ -1,4 +1,4 @@
  1     -# ðŸ” Code Review - 11/9/2025, 3:24:13 PM
      1 +# ðŸ” Code Review - 11/9/2025, 3:29:32 PM
  2   2  
  3   3  **Project:** AI Visual Code Review
  4   4  **Generated by:** AI Visual Code Review v2.0
@@ -6,11 +6,1449 @@
  6   6  ## ðŸ“Š Change Summary
  7   7  
  8   8  ```
  9     -script.js | 12 +++++++++++-
 10     - 1 file changed, 11 insertions(+), 1 deletion(-)
      9 +AI_REVIEW.md | 1403 +---------------------------------------------------------
     10 + script.js    |   65 +--
     11 + 2 files changed, 34 insertions(+), 1434 deletions(-)
 11  12  ```
 12  13  
 13     -## ðŸ“ Files Changed (1/1 selected)
     14 +## ðŸ“ Files Changed (2/2 selected)
     15 +
     16 +
     17 +### ðŸ“„ `AI_REVIEW.md`
     18 +
     19 +**Type:** Documentation ðŸ“–
     20 +
     21 +```diff
     22 +@@ -1,4 +1,4 @@
     23 +  1     -# ðŸ” Code Review - 11/8/2025, 6:43:07 PM
     24 +      1 +# ðŸ” Code Review - 11/9/2025, 3:24:13 PM
     25 +  2   2  
     26 +  3   3  **Project:** AI Visual Code Review
     27 +  4   4  **Generated by:** AI Visual Code Review v2.0
     28 +@@ -6,1392 +6,37 @@
     29 +  6   6  ## ðŸ“Š Change Summary
     30 +  7   7  
     31 +  8   8  ```
     32 +  9     -AI_REVIEW.md                           | 545 ++++++++++++++++++++++++++++++++-
     33 + 10     - src/js/core/StorageManager.js          | 202 ++++++++++++
     34 + 11     - src/js/core/ThemeManager.js            | 254 +++++++++++++++
     35 + 12     - tests/unit/core/StorageManager.test.js | 144 +++++++++
     36 + 13     - tests/unit/core/ThemeManager.test.js   | 150 +++++++++
     37 + 14     - 5 files changed, 1279 insertions(+), 16 deletions(-)
     38 +      9 +script.js | 12 +++++++++++-
     39 +     10 + 1 file changed, 11 insertions(+), 1 deletion(-)
     40 + 15  11  ```
     41 + 16  12  
     42 + 17     -## ðŸ“ Files Changed (5/5 selected)
     43 +     13 +## ðŸ“ Files Changed (1/1 selected)
     44 + 18  14  
     45 + 19  15  
     46 + 20     -### ðŸ“„ `AI_REVIEW.md`
     47 +     16 +### ðŸ“„ `script.js`
     48 + 21  17  
     49 + 22     -**Type:** Documentation ðŸ“–
     50 +     18 +**Type:** JavaScript Source File ðŸŸ¨
     51 + 23  19  
     52 + 24  20  ```diff
     53 + 25     -@@ -1,4 +1,4 @@
     54 + 26     -  1     -# ðŸ” Code Review - 11/8/2025, 6:23:18 PM
     55 + 27     -      1 +# ðŸ” Code Review - 11/8/2025, 6:29:25 PM
     56 +     21 +@@ -1,6 +1,16 @@
     57 +     22 +  1   1  // Markdown Viewer Pro - Main Script
     58 + 28  23    2   2  
     59 + 29     -  3   3  **Project:** AI Visual Code Review
     60 + 30     -  4   4  **Generated by:** AI Visual Code Review v2.0
     61 + 31     -@@ -6,27 +6,540 @@
     62 + 32     -  6   6  ## ðŸ“Š Change Summary
     63 + 33     -  7   7  
     64 + 34     -  8   8  ```
     65 + 35     -  9     -package.json | 1 +
     66 + 36     - 10     - 1 file changed, 1 insertion(+)
     67 + 37     -      9 +src/js/services/MermaidService.js          | 121 ++++++++++++++++++++++++
     68 + 38     -     10 + src/js/services/PrismService.js            | 107 +++++++++++++++++++++
     69 + 39     -     11 + tests/unit/services/MermaidService.test.js | 105 +++++++++++++++++++++
     70 + 40     -     12 + tests/unit/services/PrismService.test.js   | 143 +++++++++++++++++++++++++++++
     71 + 41     -     13 + 4 files changed, 476 insertions(+)
     72 + 42     - 11  14  ```
     73 + 43     - 12  15  
     74 + 44     - 13     -## ðŸ“ Files Changed (1/1 selected)
     75 + 45     -     16 +## ðŸ“ Files Changed (4/4 selected)
     76 + 46     - 14  17  
     77 + 47     - 15  18  
     78 + 48     - 16     -### ðŸ“„ `package.json`
     79 + 49     -     19 +### âœ¨ `src/js/services/MermaidService.js` **[ADDED]**
     80 + 50     - 17  20  
     81 + 51     - 18     -**Type:** Configuration/Data File ðŸ“‹
     82 + 52     -     21 +**Status:** âœ… **NEW FILE** - This file has been newly created
     83 + 53     -     22 +
     84 + 54     -     23 +**Type:** JavaScript Source File ðŸŸ¨
     85 + 55     - 19  24  
     86 + 56     - 20  25  ```diff
     87 + 57     - 21     -@@ -30,6 +30,7 @@
     88 + 58     - 22     - 30  30    "devDependencies": {
     89 + 59     - 23     - 31  31      "@vitest/coverage-v8": "4.0.8",
     90 + 60     - 24     - 32  32      "@vitest/ui": "4.0.8",
     91 + 61     - 25     -     33 +    "ai-visual-code-review": "2.2.1",
     92 + 62     - 26     - 33  34      "eslint": "9.39.1",
     93 + 63     - 27     - 34  35      "jsdom": "27.1.0",
     94 + 64     - 28     - 35  36      "prettier": "3.6.2",
     95 + 65     - 29     - 36  37  
     96 + 66     -     26 +@@ -0,0 +1,121 @@
     97 + 67     -     27 +      1 +/**
     98 + 68     -     28 +      2 + * MermaidService - Mermaid Diagram Rendering Service
     99 + 69     -     29 +      3 + *
    100 + 70     -     30 +      4 + * Handles all Mermaid diagram rendering with theme-aware configuration.
    101 + 71     -     31 +      5 + * Isolated service for better testability and maintainability.
    102 + 72     -     32 +      6 + */
    103 + 73     -     33 +      7 +
    104 + 74     -     34 +      8 +import { MERMAID_CONFIG } from '../config/constants.js';
    105 + 75     -     35 +      9 +import { getCssVariable } from '../utils/colorHelpers.js';
    106 + 76     -     36 +     10 +
    107 + 77     -     37 +     11 +/**
    108 + 78     -     38 +     12 + * @class MermaidService
    109 + 79     -     39 +     13 + * @description Service for rendering Mermaid diagrams with theme integration
    110 + 80     -     40 +     14 + *
    111 + 81     -     41 +     15 + * @example
    112 + 82     -     42 +     16 + * const service = new MermaidService();
    113 + 83     -     43 +     17 + * service.initialize();
    114 + 84     -     44 +     18 + * const svg = await service.render('diagram-1', 'graph TD\n A-->B');
    115 + 85     -     45 +     19 + */
    116 + 86     -     46 +     20 +export class MermaidService {
    117 + 87     -     47 +     21 +  constructor() {
    118 + 88     -     48 +     22 +    this.initialized = false;
    119 + 89     -     49 +     23 +  }
    120 + 90     -     50 +     24 +
    121 + 91     -     51 +     25 +  /**
    122 + 92     -     52 +     26 +   * Initialize Mermaid with current theme colors
    123 + 93     -     53 +     27 +   * Extracts theme colors from CSS variables and configures Mermaid
    124 + 94     -     54 +     28 +   *
    125 + 95     -     55 +     29 +   * @returns {void}
    126 + 96     -     56 +     30 +   */
    127 + 97     -     57 +     31 +  initialize() {
    128 + 98     -     58 +     32 +    // Extract theme colors from CSS variables
    129 + 99     -     59 +     33 +    const h1Color = getCssVariable('--h1-color');
    130 +100     -     60 +     34 +    const h2Color = getCssVariable('--h2-color');
    131 +101     -     61 +     35 +    const h3Color = getCssVariable('--h3-color');
    132 +102     -     62 +     36 +    const bgSecondary = getCssVariable('--bg-secondary');
    133 +103     -     63 +     37 +    const textPrimary = getCssVariable('--text-primary');
    134 +104     -     64 +     38 +
    135 +105     -     65 +     39 +    // Configure Mermaid with theme colors
    136 +106     -     66 +     40 +    if (typeof mermaid !== 'undefined') {
    137 +107     -     67 +     41 +      mermaid.initialize({
    138 +108     -     68 +     42 +        startOnLoad: MERMAID_CONFIG.START_ON_LOAD,
    139 +109     -     69 +     43 +        theme: MERMAID_CONFIG.THEME,
    140 +110     -     70 +     44 +        themeVariables: {
    141 +111     -     71 +     45 +          primaryColor: bgSecondary,
    142 +112     -     72 +     46 +          primaryTextColor: textPrimary,
    143 +113     -     73 +     47 +          primaryBorderColor: h1Color,
    144 +114     -     74 +     48 +          lineColor: h2Color,
    145 +115     -     75 +     49 +          secondaryColor: bgSecondary,
    146 +116     -     76 +     50 +          tertiaryColor: bgSecondary,
    147 +117     -     77 +     51 +          background: bgSecondary,
    148 +118     -     78 +     52 +          mainBkg: bgSecondary,
    149 +119     -     79 +     53 +          secondBkg: bgSecondary,
    150 +120     -     80 +     54 +          tertiaryBkg: bgSecondary,
    151 +121     -     81 +     55 +          nodeBorder: h1Color,
    152 +122     -     82 +     56 +          clusterBkg: bgSecondary,
    153 +123     -     83 +     57 +          clusterBorder: h3Color,
    154 +124     -     84 +     58 +          titleColor: textPrimary,
    155 +125     -     85 +     59 +          edgeLabelBackground: bgSecondary,
    156 +126     -     86 +     60 +          nodeTextColor: textPrimary,
    157 +127     -     87 +     61 +          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
    158 +128     -     88 +     62 +        },
    159 +129     -     89 +     63 +      });
    160 +130     -     90 +     64 +
    161 +131     -     91 +     65 +      this.initialized = true;
    162 +132     -     92 +     66 +    } else {
    163 +133     -     93 +     67 +      console.warn('Mermaid library not loaded');
    164 +134     -     94 +     68 +    }
    165 +135     -     95 +     69 +  }
    166 +136     -     96 +     70 +
    167 +137     -     97 +     71 +  /**
    168 +138     -     98 +     72 +   * Render a Mermaid diagram
    169 +139     -     99 +     73 +   *
    170 +140     -    100 +     74 +   * @param {string} id - Unique ID for the diagram
    171 +141     -    101 +     75 +   * @param {string} code - Mermaid diagram code
    172 +142     -    102 +     76 +   * @returns {Promise<string>} Rendered SVG string
    173 +143     -    103 +     77 +   * @throws {Error} If rendering fails
    174 +144     -    104 +     78 +   *
    175 +145     -    105 +     79 +   * @example
    176 +146     -    106 +     80 +   * const svg = await service.render('diagram-1', 'graph TD\n A-->B');
    177 +147     -    107 +     81 +   */
    178 +148     -    108 +     82 +  async render(id, code) {
    179 +149     -    109 +     83 +    // Initialize if not already done
    180 +150     -    110 +     84 +    if (!this.initialized) {
    181 +151     -    111 +     85 +      this.initialize();
    182 +152     -    112 +     86 +    }
    183 +153     -    113 +     87 +
    184 +154     -    114 +     88 +    // Check if Mermaid is available
    185 +155     -    115 +     89 +    if (typeof mermaid === 'undefined') {
    186 +156     -    116 +     90 +      throw new Error('Mermaid library not loaded');
    187 +157     -    117 +     91 +    }
    188 +158     -    118 +     92 +
    189 +159     -    119 +     93 +    try {
    190 +160     -    120 +     94 +      const result = await mermaid.render(id, code);
    191 +161     -    121 +     95 +      return result.svg;
    192 +162     -    122 +     96 +    } catch (error) {
    193 +163     -    123 +     97 +      console.error('Mermaid render error:', error);
    194 +164     -    124 +     98 +      throw new Error(`Mermaid diagram error: ${error.message}`);
    195 +165     -    125 +     99 +    }
    196 +166     -    126 +    100 +  }
    197 +167     -    127 +    101 +
    198 +168     -    128 +    102 +  /**
    199 +169     -    129 +    103 +   * Check if service is ready to render
    200 +170     -    130 +    104 +   *
    201 +171     -    131 +    105 +   * @returns {boolean} True if initialized
    202 +172     -    132 +    106 +   */
    203 +173     -    133 +    107 +  isReady() {
    204 +174     -    134 +    108 +    return this.initialized && typeof mermaid !== 'undefined';
    205 +175     -    135 +    109 +  }
    206 +176     -    136 +    110 +
    207 +177     -    137 +    111 +  /**
    208 +178     -    138 +    112 +   * Reinitialize with new theme colors
    209 +179     -    139 +    113 +   * Call this when theme changes
    210 +180     -    140 +    114 +   *
    211 +181     -    141 +    115 +   * @returns {void}
    212 +182     -    142 +    116 +   */
    213 +183     -    143 +    117 +  reinitialize() {
    214 +184     -    144 +    118 +    this.initialized = false;
    215 +185     -    145 +    119 +    this.initialize();
    216 +186     -    146 +    120 +  }
    217 +187     -    147 +    121 +}
    218 +188     -    148 +    122  
    219 +189     -    149 +
    220 +190     -    150 +```
    221 +191     -    151 +
    222 +192     -    152 +
    223 +193     -    153 +### âœ¨ `src/js/services/PrismService.js` **[ADDED]**
    224 +194     -    154 +
    225 +195     -    155 +**Status:** âœ… **NEW FILE** - This file has been newly created
    226 +196     -    156 +
    227 +197     -    157 +**Type:** JavaScript Source File ðŸŸ¨
    228 +198     -    158 +
    229 +199     -    159 +```diff
    230 +200     -    160 +@@ -0,0 +1,107 @@
    231 +201     -    161 +      1 +/**
    232 +202     -    162 +      2 + * PrismService - Syntax Highlighting Service
    233 +203     -    163 +      3 + *
    234 +204     -    164 +      4 + * Handles all syntax highlighting using Prism.js.
    235 +205     -    165 +      5 + * Isolated service for better testability and maintainability.
    236 +206     -    166 +      6 + */
    237 +207     -    167 +      7 +
    238 +208     -    168 +      8 +/**
    239 +209     -    169 +      9 + * @class PrismService
    240 +210     -    170 +     10 + * @description Service for applying syntax highlighting to code blocks
    241 +211     -    171 +     11 + *
    242 +212     -    172 +     12 + * @example
    243 +213     -    173 +     13 + * const service = new PrismService();
    244 +214     -    174 +     14 + * service.highlightAll(previewElement);
    245 +215     -    175 +     15 + */
    246 +216     -    176 +     16 +export class PrismService {
    247 +217     -    177 +     17 +  /**
    248 +218     -    178 +     18 +   * Check if Prism library is loaded
    249 +219     -    179 +     19 +   *
    250 +220     -    180 +     20 +   * @returns {boolean} True if Prism is available
    251 +221     -    181 +     21 +   * @private
    252 +222     -    182 +     22 +   */
    253 +223     -    183 +     23 +  isPrismLoaded() {
    254 +224     -    184 +     24 +    return typeof Prism !== 'undefined';
    255 +225     -    185 +     25 +  }
    256 +226     -    186 +     26 +
    257 +227     -    187 +     27 +  /**
    258 +228     -    188 +     28 +   * Highlight all code blocks in container
    259 +229     -    189 +     29 +   *
    260 +230     -    190 +     30 +   * @param {HTMLElement} container - Container element with code blocks
    261 +231     -    191 +     31 +   * @returns {number} Number of blocks highlighted
    262 +232     -    192 +     32 +   *
    263 +233     -    193 +     33 +   * @example
    264 +234     -    194 +     34 +   * const count = service.highlightAll(document.getElementById('preview'));
    265 +235     -    195 +     35 +   * console.log(`Highlighted ${count} code blocks`);
    266 +236     -    196 +     36 +   */
    267 +237     -    197 +     37 +  highlightAll(container) {
    268 +238     -    198 +     38 +    if (!this.isPrismLoaded()) {
    269 +239     -    199 +     39 +      console.warn('Prism library not loaded');
    270 +240     -    200 +     40 +      return 0;
    271 +241     -    201 +     41 +    }
    272 +242     -    202 +     42 +
    273 +243     -    203 +     43 +    const codeBlocks = container.querySelectorAll('pre code');
    274 +244     -    204 +     44 +    let count = 0;
    275 +245     -    205 +     45 +
    276 +246     -    206 +     46 +    codeBlocks.forEach(block => {
    277 +247     -    207 +     47 +      try {
    278 +248     -    208 +     48 +        Prism.highlightElement(block);
    279 +249     -    209 +     49 +        count++;
    280 +250     -    210 +     50 +      } catch (error) {
    281 +251     -    211 +     51 +        console.error('Prism highlight error:', error);
    282 +252     -    212 +     52 +      }
    283 +253     -    213 +     53 +    });
    284 +254     -    214 +     54 +
    285 +255     -    215 +     55 +    return count;
    286 +256     -    216 +     56 +  }
    287 +257     -    217 +     57 +
    288 +258     -    218 +     58 +  /**
    289 +259     -    219 +     59 +   * Highlight a single code block
    290 +260     -    220 +     60 +   *
    291 +261     -    221 +     61 +   * @param {HTMLElement} block - Code block element to highlight
    292 +262     -    222 +     62 +   * @returns {boolean} True if successfully highlighted
    293 +263     -    223 +     63 +   *
    294 +264     -    224 +     64 +   * @example
    295 +265     -    225 +     65 +   * const success = service.highlightElement(codeBlock);
    296 +266     -    226 +     66 +   */
    297 +267     -    227 +     67 +  highlightElement(block) {
    298 +268     -    228 +     68 +    if (!this.isPrismLoaded()) {
    299 +269     -    229 +     69 +      console.warn('Prism library not loaded');
    300 +270     -    230 +     70 +      return false;
    301 +271     -    231 +     71 +    }
    302 +272     -    232 +     72 +
    303 +273     -    233 +     73 +    try {
    304 +274     -    234 +     74 +      Prism.highlightElement(block);
    305 +275     -    235 +     75 +      return true;
    306 +276     -    236 +     76 +    } catch (error) {
    307 +277     -    237 +     77 +      console.error('Prism highlight error:', error);
    308 +278     -    238 +     78 +      return false;
    309 +279     -    239 +     79 +    }
    310 +280     -    240 +     80 +  }
    311 +281     -    241 +     81 +
    312 +282     -    242 +     82 +  /**
    313 +283     -    243 +     83 +   * Check if service is ready to highlight code
    314 +284     -    244 +     84 +   *
    315 +285     -    245 +     85 +   * @returns {boolean} True if Prism is loaded
    316 +286     -    246 +     86 +   */
    317 +287     -    247 +     87 +  isReady() {
    318 +288     -    248 +     88 +    return this.isPrismLoaded();
    319 +289     -    249 +     89 +  }
    320 +290     -    250 +     90 +
    321 +291     -    251 +     91 +  /**
    322 +292     -    252 +     92 +   * Get list of supported languages
    323 +293     -    253 +     93 +   *
    324 +294     -    254 +     94 +   * @returns {string[]} Array of language keys
    325 +295     -    255 +     95 +   *
    326 +296     -    256 +     96 +   * @example
    327 +297     -    257 +     97 +   * const languages = service.getSupportedLanguages();
    328 +298     -    258 +     98 +   * // Returns: ['javascript', 'python', 'java', ...]
    329 +299     -    259 +     99 +   */
    330 +300     -    260 +    100 +  getSupportedLanguages() {
    331 +301     -    261 +    101 +    if (!this.isPrismLoaded()) {
    332 +302     -    262 +    102 +      return [];
    333 +303     -    263 +    103 +    }
    334 +304     -    264 +    104 +
    335 +305     -    265 +    105 +    return Object.keys(Prism.languages || {});
    336 +306     -    266 +    106 +  }
    337 +307     -    267 +    107 +}
    338 +308     -    268 +    108  
    339 +309     -    269 +
    340 +310     -    270 +```
    341 +311     -    271 +
    342 +312     -    272 +
    343 +313     -    273 +### âœ¨ `tests/unit/services/MermaidService.test.js` **[ADDED]**
    344 +314     -    274 +
    345 +315     -    275 +**Status:** âœ… **NEW FILE** - This file has been newly created
    346 +316     -    276 +
    347 +317     -    277 +**Type:** JavaScript Source File ðŸŸ¨
    348 +318     -    278 +
    349 +319     -    279 +```diff
    350 +320     -    280 +@@ -0,0 +1,105 @@
    351 +321     -    281 +      1 +import { beforeEach, describe, expect, it, vi } from 'vitest';
    352 +322     -    282 +      2 +import { MermaidService } from '../../../src/js/services/MermaidService.js';
    353 +323     -    283 +      3 +
    354 +324     -    284 +      4 +describe('MermaidService', () => {
    355 +325     -    285 +      5 +  let service;
    356 +326     -    286 +      6 +  let mockMermaid;
    357 +327     -    287 +      7 +
    358 +328     -    288 +      8 +  beforeEach(() => {
    359 +329     -    289 +      9 +    service = new MermaidService();
    360 +330     -    290 +     10 +
    361 +331     -    291 +     11 +    // Mock global mermaid object
    362 +332     -    292 +     12 +    mockMermaid = {
    363 +333     -    293 +     13 +      initialize: vi.fn(),
    364 +334     -    294 +     14 +      render: vi.fn().mockResolvedValue({ svg: '<svg>Test SVG</svg>' }),
    365 +335     -    295 +     15 +    };
    366 +336     -    296 +     16 +    global.mermaid = mockMermaid;
    367 +337     -    297 +     17 +  });
    368 +338     -    298 +     18 +
    369 +339     -    299 +     19 +  describe('initialize', () => {
    370 +340     -    300 +     20 +    it('should initialize Mermaid with theme colors', () => {
    371 +341     -    301 +     21 +      service.initialize();
    372 +342     -    302 +     22 +
    373 +343     -    303 +     23 +      expect(mockMermaid.initialize).toHaveBeenCalledOnce();
    374 +344     -    304 +     24 +      expect(service.initialized).toBe(true);
    375 +345     -    305 +     25 +    });
    376 +346     -    306 +     26 +
    377 +347     -    307 +     27 +    it('should configure Mermaid with correct theme', () => {
    378 +348     -    308 +     28 +      service.initialize();
    379 +349     -    309 +     29 +
    380 +350     -    310 +     30 +      const config = mockMermaid.initialize.mock.calls[0][0];
    381 +351     -    311 +     31 +      expect(config.startOnLoad).toBe(false);
    382 +352     -    312 +     32 +      expect(config.theme).toBe('base');
    383 +353     -    313 +     33 +      expect(config.themeVariables).toBeDefined();
    384 +354     -    314 +     34 +    });
    385 +355     -    315 +     35 +
    386 +356     -    316 +     36 +    it('should extract CSS colors for theme variables', () => {
    387 +357     -    317 +     37 +      service.initialize();
    388 +358     -    318 +     38 +
    389 +359     -    319 +     39 +      const config = mockMermaid.initialize.mock.calls[0][0];
    390 +360     -    320 +     40 +      expect(config.themeVariables.primaryBorderColor).toBeTruthy();
    391 +361     -    321 +     41 +      expect(config.themeVariables.lineColor).toBeTruthy();
    392 +362     -    322 +     42 +    });
    393 +363     -    323 +     43 +  });
    394 +364     -    324 +     44 +
    395 +365     -    325 +     45 +  describe('render', () => {
    396 +366     -    326 +     46 +    it('should render Mermaid diagram', async () => {
    397 +367     -    327 +     47 +      const svg = await service.render('test-id', 'graph TD\n A-->B');
    398 +368     -    328 +     48 +
    399 +369     -    329 +     49 +      expect(svg).toContain('<svg>');
    400 +370     -    330 +     50 +      expect(mockMermaid.render).toHaveBeenCalledWith('test-id', 'graph TD\n A-->B');
    401 +371     -    331 +     51 +    });
    402 +372     -    332 +     52 +
    403 +373     -    333 +     53 +    it('should auto-initialize if not initialized', async () => {
    404 +374     -    334 +     54 +      expect(service.initialized).toBe(false);
    405 +375     -    335 +     55 +
    406 +376     -    336 +     56 +      await service.render('test-id', 'graph TD\n A-->B');
    407 +377     -    337 +     57 +
    408 +378     -    338 +     58 +      expect(service.initialized).toBe(true);
    409 +379     -    339 +     59 +    });
    410 +380     -    340 +     60 +
    411 +381     -    341 +     61 +    it('should handle render errors gracefully', async () => {
    412 +382     -    342 +     62 +      mockMermaid.render.mockRejectedValue(new Error('Parse error'));
    413 +383     -    343 +     63 +
    414 +384     -    344 +     64 +      await expect(service.render('test-id', 'invalid')).rejects.toThrow(
    415 +385     -    345 +     65 +        'Mermaid diagram error: Parse error'
    416 +386     -    346 +     66 +      );
    417 +387     -    347 +     67 +    });
    418 +388     -    348 +     68 +
    419 +389     -    349 +     69 +    it('should throw error if mermaid not loaded', async () => {
    420 +390     -    350 +     70 +      global.mermaid = undefined;
    421 +391     -    351 +     71 +      service.initialized = false;
    422 +392     -    352 +     72 +
    423 +393     -    353 +     73 +      await expect(service.render('test-id', 'graph TD\n A-->B')).rejects.toThrow(
    424 +394     -    354 +     74 +        'Mermaid library not loaded'
    425 +395     -    355 +     75 +      );
    426 +396     -    356 +     76 +    });
    427 +397     -    357 +     77 +  });
    428 +398     -    358 +     78 +
    429 +399     -    359 +     79 +  describe('isReady', () => {
    430 +400     -    360 +     80 +    it('should return true when initialized and mermaid loaded', () => {
    431 +401     -    361 +     81 +      service.initialize();
    432 +402     -    362 +     82 +      expect(service.isReady()).toBe(true);
    433 +403     -    363 +     83 +    });
    434 +404     -    364 +     84 +
    435 +405     -    365 +     85 +    it('should return false when not initialized', () => {
    436 +406     -    366 +     86 +      expect(service.isReady()).toBe(false);
    437 +407     -    367 +     87 +    });
    438 +408     -    368 +     88 +
    439 +409     -    369 +     89 +    it('should return false when mermaid not loaded', () => {
    440 +410     -    370 +     90 +      global.mermaid = undefined;
    441 +411     -    371 +     91 +      expect(service.isReady()).toBe(false);
    442 +412     -    372 +     92 +    });
    443 +413     -    373 +     93 +  });
    444 +414     -    374 +     94 +
    445 +415     -    375 +     95 +  describe('reinitialize', () => {
    446 +416     -    376 +     96 +    it('should reset and reinitialize', () => {
    447 +417     -    377 +     97 +      service.initialize();
    448 +418     -    378 +     98 +      expect(service.initialized).toBe(true);
    449 +419     -    379 +     99 +
    450 +420     -    380 +    100 +      service.reinitialize();
    451 +421     -    381 +    101 +
    452 +422     -    382 +    102 +      expect(mockMermaid.initialize).toHaveBeenCalledTimes(2);
    453 +423     -    383 +    103 +    });
    454 +424     -    384 +    104 +  });
    455 +425     -    385 +    105 +});
    456 +426     -    386 +    106  
    457 +427     -    387 +
    458 +428     -    388 +```
    459 +429     -    389 +
    460 +430     -    390 +
    461 +431     -    391 +### âœ¨ `tests/unit/services/PrismService.test.js` **[ADDED]**
    462 +432     -    392 +
    463 +433     -    393 +**Status:** âœ… **NEW FILE** - This file has been newly created
    464 +434     -    394 +
    465 +435     -    395 +**Type:** JavaScript Source File ðŸŸ¨
    466 +436     -    396 +
    467 +437     -    397 +```diff
    468 +438     -    398 +@@ -0,0 +1,143 @@
    469 +439     -    399 +      1 +import { beforeEach, describe, expect, it, vi } from 'vitest';
    470 +440     -    400 +      2 +import { PrismService } from '../../../src/js/services/PrismService.js';
    471 +441     -    401 +      3 +
    472 +442     -    402 +      4 +describe('PrismService', () => {
    473 +443     -    403 +      5 +  let service;
    474 +444     -    404 +      6 +  let mockPrism;
    475 +445     -    405 +      7 +  let mockContainer;
    476 +446     -    406 +      8 +  let mockCodeBlock;
    477 +447     -    407 +      9 +
    478 +448     -    408 +     10 +  beforeEach(() => {
    479 +449     -    409 +     11 +    service = new PrismService();
    480 +450     -    410 +     12 +
    481 +451     -    411 +     13 +    // Mock Prism object
    482 +452     -    412 +     14 +    mockPrism = {
    483 +453     -    413 +     15 +      highlightElement: vi.fn(),
    484 +454     -    414 +     16 +      languages: {
    485 +455     -    415 +     17 +        javascript: {},
    486 +456     -    416 +     18 +        python: {},
    487 +457     -    417 +     19 +        java: {},
    488 +458     -    418 +     20 +      },
    489 +459     -    419 +     21 +    };
    490 +460     -    420 +     22 +    global.Prism = mockPrism;
    491 +461     -    421 +     23 +
    492 +462     -    422 +     24 +    // Mock DOM elements
    493 +463     -    423 +     25 +    mockCodeBlock = document.createElement('code');
    494 +464     -    424 +     26 +    mockContainer = document.createElement('div');
    495 +465     -    425 +     27 +    const pre = document.createElement('pre');
    496 +466     -    426 +     28 +    pre.appendChild(mockCodeBlock);
    497 +467     -    427 +     29 +    mockContainer.appendChild(pre);
    498 +468     -    428 +     30 +  });
    499 +469     -    429 +     31 +
    500 +470     -    430 +     32 +  describe('highlightAll', () => {
    501 +471     -    431 +     33 +    it('should highlight all code blocks in container', () => {
    502 +472     -    432 +     34 +      const count = service.highlightAll(mockContainer);
    503 +473     -    433 +     35 +
    504 +474     -    434 +     36 +      expect(count).toBe(1);
    505 +475     -    435 +     37 +      expect(mockPrism.highlightElement).toHaveBeenCalledOnce();
    506 +476     -    436 +     38 +      expect(mockPrism.highlightElement).toHaveBeenCalledWith(mockCodeBlock);
    507 +477     -    437 +     39 +    });
    508 +478     -    438 +     40 +
    509 +479     -    439 +     41 +    it('should return 0 if Prism not loaded', () => {
    510 +480     -    440 +     42 +      global.Prism = undefined;
    511 +481     -    441 +     43 +
    512 +482     -    442 +     44 +      const count = service.highlightAll(mockContainer);
    513 +483     -    443 +     45 +
    514 +484     -    444 +     46 +      expect(count).toBe(0);
    515 +485     -    445 +     47 +    });
    516 +486     -    446 +     48 +
    517 +487     -    447 +     49 +    it('should handle multiple code blocks', () => {
    518 +488     -    448 +     50 +      // Add more code blocks
    519 +489     -    449 +     51 +      for (let i = 0; i < 3; i++) {
    520 +490     -    450 +     52 +        const pre = document.createElement('pre');
    521 +491     -    451 +     53 +        const code = document.createElement('code');
    522 +492     -    452 +     54 +        pre.appendChild(code);
    523 +493     -    453 +     55 +        mockContainer.appendChild(pre);
    524 +494     -    454 +     56 +      }
    525 +495     -    455 +     57 +
    526 +496     -    456 +     58 +      const count = service.highlightAll(mockContainer);
    527 +497     -    457 +     59 +
    528 +498     -    458 +     60 +      expect(count).toBe(4); // 1 original + 3 added
    529 +499     -    459 +     61 +      expect(mockPrism.highlightElement).toHaveBeenCalledTimes(4);
    530 +500     -    460 +     62 +    });
    531 +501     -    461 +     63 +
    532 +502     -    462 +     64 +    it('should continue if one block fails', () => {
    533 +503     -    463 +     65 +      // Add another block
    534 +504     -    464 +     66 +      const pre = document.createElement('pre');
    535 +505     -    465 +     67 +      const code = document.createElement('code');
    536 +506     -    466 +     68 +      pre.appendChild(code);
    537 +507     -    467 +     69 +      mockContainer.appendChild(pre);
    538 +508     -    468 +     70 +
    539 +509     -    469 +     71 +      // Make first call fail
    540 +510     -    470 +     72 +      mockPrism.highlightElement.mockImplementationOnce(() => {
    541 +511     -    471 +     73 +        throw new Error('Highlight failed');
    542 +512     -    472 +     74 +      });
    543 +513     -    473 +     75 +
    544 +514     -    474 +     76 +      const count = service.highlightAll(mockContainer);
    545 +515     -    475 +     77 +
    546 +516     -    476 +     78 +      expect(count).toBe(1); // Only second block succeeded
    547 +517     -    477 +     79 +    });
    548 +518     -    478 +     80 +  });
    549 +519     -    479 +     81 +
    550 +520     -    480 +     82 +  describe('highlightElement', () => {
    551 +521     -    481 +     83 +    it('should highlight single code block', () => {
    552 +522     -    482 +     84 +      const success = service.highlightElement(mockCodeBlock);
    553 +523     -    483 +     85 +
    554 +524     -    484 +     86 +      expect(success).toBe(true);
    555 +525     -    485 +     87 +      expect(mockPrism.highlightElement).toHaveBeenCalledWith(mockCodeBlock);
    556 +526     -    486 +     88 +    });
    557 +527     -    487 +     89 +
    558 +528     -    488 +     90 +    it('should return false if Prism not loaded', () => {
    559 +529     -    489 +     91 +      global.Prism = undefined;
    560 +530     -    490 +     92 +
    561 +531     -    491 +     93 +      const success = service.highlightElement(mockCodeBlock);
    562 +532     -    492 +     94 +
    563 +533     -    493 +     95 +      expect(success).toBe(false);
    564 +534     -    494 +     96 +    });
    565 +535     -    495 +     97 +
    566 +536     -    496 +     98 +    it('should return false on error', () => {
    567 +537     -    497 +     99 +      mockPrism.highlightElement.mockImplementation(() => {
    568 +538     -    498 +    100 +        throw new Error('Highlight failed');
    569 +539     -    499 +    101 +      });
    570 +540     -    500 +    102 +
    571 +541     -    501 +    103 +      const success = service.highlightElement(mockCodeBlock);
    572 +542     -    502 +    104 +
    573 +543     -    503 +    105 +      expect(success).toBe(false);
    574 +544     -    504 +    106 +    });
    575 +545     -    505 +    107 +  });
    576 +546     -    506 +    108 +
    577 +547     -    507 +    109 +  describe('isReady', () => {
    578 +548     -    508 +    110 +    it('should return true when Prism is loaded', () => {
    579 +549     -    509 +    111 +      expect(service.isReady()).toBe(true);
    580 +550     -    510 +    112 +    });
    581 +551     -    511 +    113 +
    582 +552     -    512 +    114 +    it('should return false when Prism not loaded', () => {
    583 +553     -    513 +    115 +      global.Prism = undefined;
    584 +554     -    514 +    116 +      expect(service.isReady()).toBe(false);
    585 +555     -    515 +    117 +    });
    586 +556     -    516 +    118 +  });
    587 +557     -    517 +    119 +
    588 +558     -    518 +    120 +  describe('getSupportedLanguages', () => {
    589 +559     -    519 +    121 +    it('should return list of supported languages', () => {
    590 +560     -    520 +    122 +      const languages = service.getSupportedLanguages();
    591 +561     -    521 +    123 +
    592 +562     -    522 +    124 +      expect(languages).toEqual(['javascript', 'python', 'java']);
    593 +563     -    523 +    125 +    });
    594 +564     -    524 +    126 +
    595 +565     -    525 +    127 +    it('should return empty array if Prism not loaded', () => {
    596 +566     -    526 +    128 +      global.Prism = undefined;
    597 +567     -    527 +    129 +
    598 +568     -    528 +    130 +      const languages = service.getSupportedLanguages();
    599 +569     -    529 +    131 +
    600 +570     -    530 +    132 +      expect(languages).toEqual([]);
    601 +571     -    531 +    133 +    });
    602 +572     -    532 +    134 +
    603 +573     -    533 +    135 +    it('should handle missing languages object', () => {
    604 +574     -    534 +    136 +      global.Prism = {};
    605 +575     -    535 +    137 +
    606 +576     -    536 +    138 +      const languages = service.getSupportedLanguages();
    607 +577     -    537 +    139 +
    608 +578     -    538 +    140 +      expect(languages).toEqual([]);
    609 +579     -    539 +    141 +    });
    610 +580     -    540 +    142 +  });
    611 +581     -    541 +    143 +});
    612 +582     -    542 +    144  
    613 +583     - 30 543  
    614 +584     - 31 544  ```
    615 +585     - 32 545  
    616 +586     -@@ -72,4 +585,4 @@ Please provide specific feedback on:
    617 +587     - 72 585  
    618 +588     - 73 586  ---
    619 +589     - 74 587  *Generated by AI Visual Code Review v2.0 - Unified Export Script*
    620 +590     - 75     -*Files processed: 1/1 | Errors: 0 | Generated: 2025-11-08T12:53:18.378Z*
    621 +591     -    588 +*Files processed: 4/4 | Errors: 0 | Generated: 2025-11-08T12:59:25.939Z*
    622 +592     - 76 589  
    623 +593     -
    624 +594     -```
    625 +595     -
    626 +596     -
    627 +597     -### âœ¨ `src/js/core/StorageManager.js` **[ADDED]**
    628 +598     -
    629 +599     -**Status:** âœ… **NEW FILE** - This file has been newly created
    630 +600     -
    631 +601     -**Type:** JavaScript Source File ðŸŸ¨
    632 +602     -
    633 +603     -```diff
    634 +604     -@@ -0,0 +1,202 @@
    635 +605     -      1 +/**
    636 +606     -      2 + * StorageManager - LocalStorage Abstraction Layer
    637 +607     -      3 + *
    638 +608     -      4 + * Provides a clean interface for localStorage operations with error handling.
    639 +609     -      5 + * Centralizes all data persistence logic for better testability.
    640 +610     -      6 + */
    641 +611     -      7 +
    642 +612     -      8 +/**
    643 +613     -      9 + * @class StorageManager
    644 +614     -     10 + * @description Manages all localStorage operations with error handling
    645 +615     -     11 + *
    646 +616     -     12 + * @example
    647 +617     -     13 + * const storage = new StorageManager();
    648 +618     -     14 + * storage.set(STORAGE_KEYS.MARKDOWN_CONTENT, 'Hello World');
    649 +619     -     15 + * const content = storage.get(STORAGE_KEYS.MARKDOWN_CONTENT);
    650 +620     -     16 + */
    651 +621     -     17 +export class StorageManager {
    652 +622     -     18 +  constructor() {
    653 +623     -     19 +    this.CURRENT_VERSION = 2;
    654 +624     -     20 +    this.VERSION_KEY = '__storage_version';
    655 +625     -     21 +  }
    656 +626     -     22 +
    657 +627     -     23 +  /**
    658 +628     -     24 +   * Get item from localStorage
    659 +629     -     25 +   *
    660 +630     -     26 +   * @param {string} key - Storage key
    661 +631     -     27 +   * @returns {string|null} Stored value or null if not found
    662 +632     -     28 +   *
    663 +633     -     29 +   * @example
    664 +634     -     30 +   * const theme = storage.get(STORAGE_KEYS.SELECTED_THEME);
    665 +635     -     31 +   */
    666 +636     -     32 +  get(key) {
    667 +637     -     33 +    try {
    668 +638     -     34 +      return localStorage.getItem(key);
    669 +639     -     35 +    } catch (error) {
    670 +640     -     36 +      console.error('Storage get error:', error);
    671 +641     -     37 +      return null;
    672 +642     -     38 +    }
    673 +643     -     39 +  }
    674 +644     -     40 +
    675 +645     -     41 +  /**
    676 +646     -     42 +   * Set item in localStorage
    677 +647     -     43 +   *
    678 +648     -     44 +   * @param {string} key - Storage key
    679 +649     -     45 +   * @param {string} value - Value to store
    680 +650     -     46 +   * @returns {boolean} True if successful
    681 +651     -     47 +   *
    682 +652     -     48 +   * @example
    683 +653     -     49 +   * storage.set(STORAGE_KEYS.SELECTED_THEME, 'ocean-dark');
    684 +654     -     50 +   */
    685 +655     -     51 +  set(key, value) {
    686 +656     -     52 +    try {
    687 +657     -     53 +      localStorage.setItem(key, value);
    688 +658     -     54 +      return true;
    689 +659     -     55 +    } catch (error) {
    690 +660     -     56 +      console.error('Storage set error:', error);
    691 +661     -     57 +      return false;
    692 +662     -     58 +    }
    693 +663     -     59 +  }
    694 +664     -     60 +
    695 +665     -     61 +  /**
    696 +666     -     62 +   * Remove item from localStorage
    697 +667     -     63 +   *
    698 +668     -     64 +   * @param {string} key - Storage key
    699 +669     -     65 +   * @returns {boolean} True if successful
    700 +670     -     66 +   *
    701 +671     -     67 +   * @example
    702 +672     -     68 +   * storage.remove(STORAGE_KEYS.CUSTOM_THEME);
    703 +673     -     69 +   */
    704 +674     -     70 +  remove(key) {
    705 +675     -     71 +    try {
    706 +676     -     72 +      localStorage.removeItem(key);
    707 +677     -     73 +      return true;
    708 +678     -     74 +    } catch (error) {
    709 +679     -     75 +      console.error('Storage remove error:', error);
    710 +680     -     76 +      return false;
    711 +681     -     77 +    }
    712 +682     -     78 +  }
    713 +683     -     79 +
    714 +684     -     80 +  /**
    715 +685     -     81 +   * Check if key exists in storage
    716 +686     -     82 +   *
    717 +687     -     83 +   * @param {string} key - Storage key
    718 +688     -     84 +   * @returns {boolean} True if key exists
    719 +689     -     85 +   *
    720 +690     -     86 +   * @example
    721 +691     -     87 +   * if (storage.has(STORAGE_KEYS.CUSTOM_THEME)) { }
    722 +692     -     88 +   */
    723 +693     -     89 +  has(key) {
    724 +694     -     90 +    return this.get(key) !== null;
    725 +695     -     91 +  }
    726 +696     -     92 +
    727 +697     -     93 +  /**
    728 +698     -     94 +   * Get JSON object from storage
    729 +699     -     95 +   *
    730 +700     -     96 +   * @param {string} key - Storage key
    731 +701     -     97 +   * @returns {any|null} Parsed JSON or null if not found/invalid
    732 +702     -     98 +   *
    733 +703     -     99 +   * @example
    734 +704     -    100 +   * const theme = storage.getJSON(STORAGE_KEYS.CUSTOM_THEME);
    735 +705     -    101 +   */
    736 +706     -    102 +  getJSON(key) {
    737 +707     -    103 +    const value = this.get(key);
    738 +708     -    104 +    if (!value) {
    739 +709     -    105 +      return null;
    740 +710     -    106 +    }
    741 +711     -    107 +
    742 +712     -    108 +    try {
    743 +713     -    109 +      return JSON.parse(value);
    744 +714     -    110 +    } catch (error) {
    745 +715     -    111 +      console.error('JSON parse error:', error);
    746 +716     -    112 +      return null;
    747 +717     -    113 +    }
    748 +718     -    114 +  }
    749 +719     -    115 +
    750 +720     -    116 +  /**
    751 +721     -    117 +   * Set JSON object in storage
    752 +722     -    118 +   *
    753 +723     -    119 +   * @param {string} key - Storage key
    754 +724     -    120 +   * @param {any} value - Value to stringify and store
    755 +725     -    121 +   * @returns {boolean} True if successful
    756 +726     -    122 +   *
    757 +727     -    123 +   * @example
    758 +728     -    124 +   * storage.setJSON(STORAGE_KEYS.CUSTOM_THEME, { '--h1-color': '#ff0000' });
    759 +729     -    125 +   */
    760 +730     -    126 +  setJSON(key, value) {
    761 +731     -    127 +    try {
    762 +732     -    128 +      const json = JSON.stringify(value);
    763 +733     -    129 +      return this.set(key, json);
    764 +734     -    130 +    } catch (error) {
    765 +735     -    131 +      console.error('JSON stringify error:', error);
    766 +736     -    132 +      return false;
    767 +737     -    133 +    }
    768 +738     -    134 +  }
    769 +739     -    135 +
    770 +740     -    136 +  /**
    771 +741     -    137 +   * Clear all items from storage
    772 +742     -    138 +   * USE WITH CAUTION
    773 +743     -    139 +   *
    774 +744     -    140 +   * @returns {boolean} True if successful
    775 +745     -    141 +   */
    776 +746     -    142 +  clear() {
    777 +747     -    143 +    try {
    778 +748     -    144 +      localStorage.clear();
    779 +749     -    145 +      return true;
    780 +750     -    146 +    } catch (error) {
    781 +751     -    147 +      console.error('Storage clear error:', error);
    782 +752     -    148 +      return false;
    783 +753     -    149 +    }
    784 +754     -    150 +  }
    785 +755     -    151 +
    786 +756     -    152 +  /**
    787 +757     -    153 +   * Get all keys in storage
    788 +758     -    154 +   *
    789 +759     -    155 +   * @returns {string[]} Array of storage keys
    790 +760     -    156 +   */
    791 +761     -    157 +  getAllKeys() {
    792 +762     -    158 +    try {
    793 +763     -    159 +      return Object.keys(localStorage);
    794 +764     -    160 +    } catch (error) {
    795 +765     -    161 +      console.error('Storage getAllKeys error:', error);
    796 +766     -    162 +      return [];
    797 +767     -    163 +    }
    798 +768     -    164 +  }
    799 +769     -    165 +
    800 +770     -    166 +  /**
    801 +771     -    167 +   * Get storage size in bytes (approximate)
    802 +772     -    168 +   *
    803 +773     -    169 +   * @returns {number} Approximate size in bytes
    804 +774     -    170 +   */
    805 +775     -    171 +  getSize() {
    806 +776     -    172 +    try {
    807 +777     -    173 +      let total = 0;
    808 +778     -    174 +      for (const key in localStorage) {
    809 +779     -    175 +        if (localStorage.hasOwnProperty(key)) {
    810 +780     -    176 +          const value = localStorage.getItem(key);
    811 +781     -    177 +          total += key.length + (value?.length || 0);
    812 +782     -    178 +        }
    813 +783     -    179 +      }
    814 +784     -    180 +      return total;
    815 +785     -    181 +    } catch (error) {
    816 +786     -    182 +      console.error('Storage getSize error:', error);
    817 +787     -    183 +      return 0;
    818 +788     -    184 +    }
    819 +789     -    185 +  }
    820 +790     -    186 +
    821 +791     -    187 +  /**
    822 +792     -    188 +   * Check if storage is available
    823 +793     -    189 +   *
    824 +794     -    190 +   * @returns {boolean} True if localStorage is available
    825 +795     -    191 +   */
    826 +796     -    192 +  isAvailable() {
    827 +797     -    193 +    try {
    828 +798     -    194 +      const test = '__storage_test__';
    829 +799     -    195 +      localStorage.setItem(test, test);
    830 +800     -    196 +      localStorage.removeItem(test);
    831 +801     -    197 +      return true;
    832 +802     -    198 +    } catch (error) {
    833 +803     -    199 +      return false;
    834 +804     -    200 +    }
    835 +805     -    201 +  }
    836 +806     -    202 +}
    837 +807     -    203  
    838 +808     -
    839 +809     -```
    840 +810     -
    841 +811     -
    842 +812     -### âœ¨ `src/js/core/ThemeManager.js` **[ADDED]**
    843 +813     -
    844 +814     -**Status:** âœ… **NEW FILE** - This file has been newly created
    845 +815     -
    846 +816     -**Type:** JavaScript Source File ðŸŸ¨
    847 +817     -
    848 +818     -```diff
    849 +819     -@@ -0,0 +1,254 @@
    850 +820     -      1 +/**
    851 +821     -      2 + * ThemeManager - Theme Management Core Module
    852 +822     -      3 + *
    853 +823     -      4 + * Handles all theme operations: loading, switching, customization, and persistence.
    854 +824     -      5 + * Integrates with StorageManager for persistence and MermaidService for theme updates.
    855 +825     -      6 + */
    856 +826     -      7 +
    857 +827     -      8 +import { ELEMENT_IDS, STORAGE_KEYS, THEMES } from '../config/constants.js';
    858 +828     -      9 +import { getCssVariable, removeCssVariable, setCssVariable } from '../utils/colorHelpers.js';
    859 +829     -     10 +import { isValidTheme } from '../utils/validators.js';
    860 +830     -     11 +
    861 +831     -     12 +/**
    862 +832     -     13 + * @class ThemeManager
    863 +833     -     14 + * @description Manages theme loading, switching, and customization
    864 +834     -     15 + *
    865 +835     -     16 + * @example
    866 +836     -     17 + * const storage = new StorageManager();
    867 +837     -     18 + * const themeManager = new ThemeManager(storage);
    868 +838     -     19 + * await themeManager.loadTheme('ocean-dark');
    869 +839     -     20 + */
    870 +840     -     21 +export class ThemeManager {
    871 +841     -     22 +  /**
    872 +842     -     23 +   * @param {StorageManager} storageManager - Storage manager instance
    873 +843     -     24 +   */
    874 +844     -     25 +  constructor(storageManager) {
    875 +845     -     26 +    this.storage = storageManager;
    876 +846     -     27 +    this.currentTheme = null;
    877 +847     -     28 +    this.onThemeChange = null;
    878 +848     -     29 +  }
    879 +849     -     30 +
    880 +850     -     31 +  /**
    881 +851     -     32 +   * Load and apply a theme
    882 +852     -     33 +   *
    883 +853     -     34 +   * @param {string} themeName - Name of theme to load
    884 +854     -     35 +   * @returns {Promise<boolean>} True if successful
    885 +855     -     36 +   * @throws {Error} If theme name is invalid
    886 +856     -     37 +   *
    887 +857     -     38 +   * @example
    888 +858     -     39 +   * await themeManager.loadTheme('obsidian-dark');
    889 +859     -     40 +   */
    890 +860     -     41 +  async loadTheme(themeName) {
    891 +861     -     42 +    // Validate theme name
    892 +862     -     43 +    if (!isValidTheme(themeName)) {
    893 +863     -     44 +      throw new Error(`Invalid theme: ${themeName}`);
    894 +864     -     45 +    }
    895 +865     -     46 +
    896 +866     -     47 +    // Load appropriate theme
    897 +867     -     48 +    if (themeName === THEMES.CUSTOM) {
    898 +868     -     49 +      return this.loadCustomTheme();
    899 +869     -     50 +    }
    900 +870     -     51 +
    901 +871     -     52 +    return this.loadBuiltInTheme(themeName);
    902 +872     -     53 +  }
    903 +873     -     54 +
    904 +874     -     55 +  /**
    905 +875     -     56 +   * Load a built-in theme from CSS file
    906 +876     -     57 +   *
    907 +877     -     58 +   * @param {string} themeName - Built-in theme name
    908 +878     -     59 +   * @returns {Promise<boolean>} True if successful
    909 +879     -     60 +   * @private
    910 +880     -     61 +   */
    911 +881     -     62 +  async loadBuiltInTheme(themeName) {
    912 +882     -     63 +    try {
    913 +883     -     64 +      // Clear any custom inline styles
    914 +884     -     65 +      this.clearInlineStyles();
    915 +885     -     66 +
    916 +886     -     67 +      // Load theme stylesheet
    917 +887     -     68 +      const stylesheet = document.getElementById(ELEMENT_IDS.THEME_STYLESHEET);
    918 +888     -     69 +      if (!stylesheet) {
    919 +889     -     70 +        throw new Error('Theme stylesheet element not found');
    920 +890     -     71 +      }
    921 +891     -     72 +
    922 +892     -     73 +      stylesheet.href = `themes/${themeName}.css`;
    923 +893     -     74 +
    924 +894     -     75 +      // Save selection
    925 +895     -     76 +      this.currentTheme = themeName;
    926 +896     -     77 +      this.storage.set(STORAGE_KEYS.SELECTED_THEME, themeName);
    927 +897     -     78 +
    928 +898     -     79 +      // Notify listeners
    929 +899     -     80 +      this.notifyThemeChange(themeName);
    930 +900     -     81 +
    931 +901     -     82 +      return true;
    932 +902     -     83 +    } catch (error) {
    933 +903     -     84 +      console.error('Failed to load built-in theme:', error);
    934 +904     -     85 +      return false;
    935 +905     -     86 +    }
    936 +906     -     87 +  }
    937 +907     -     88 +
    938 +908     -     89 +  /**
    939 +909     -     90 +   * Load custom theme from storage
    940 +910     -     91 +   *
    941 +911     -     92 +   * @returns {Promise<boolean>} True if successful
    942 +912     -     93 +   * @private
    943 +913     -     94 +   */
    944 +914     -     95 +  async loadCustomTheme() {
    945 +915     -     96 +    const customTheme = this.storage.getJSON(STORAGE_KEYS.CUSTOM_THEME);
    946 +916     -     97 +
    947 +917     -     98 +    if (!customTheme) {
    948 +918     -     99 +      console.warn('No custom theme found, loading default');
    949 +919     -    100 +      return this.loadTheme(THEMES.DEFAULT_LIGHT);
    950 +920     -    101 +    }
    951 +921     -    102 +
    952 +922     -    103 +    try {
    953 +923     -    104 +      // Apply custom colors
    954 +924     -    105 +      Object.entries(customTheme).forEach(([property, value]) => {
    955 +925     -    106 +        setCssVariable(property, value);
    956 +926     -    107 +      });
    957 +927     -    108 +
    958 +928     -    109 +      this.currentTheme = THEMES.CUSTOM;
    959 +929     -    110 +      this.storage.set(STORAGE_KEYS.SELECTED_THEME, THEMES.CUSTOM);
    960 +930     -    111 +
    961 +931     -    112 +      // Notify listeners
    962 +932     -    113 +      this.notifyThemeChange(THEMES.CUSTOM);
    963 +933     -    114 +
    964 +934     -    115 +      return true;
    965 +935     -    116 +    } catch (error) {
    966 +936     -    117 +      console.error('Failed to load custom theme:', error);
    967 +937     -    118 +      return false;
    968 +938     -    119 +    }
    969 +939     -    120 +  }
    970 +940     -    121 +
    971 +941     -    122 +  /**
    972 +942     -    123 +   * Save custom theme colors
    973 +943     -    124 +   *
    974 +944     -    125 +   * @param {Object} colors - Object with CSS variable names as keys
    975 +945     -    126 +   * @returns {boolean} True if successful
    976 +946     -    127 +   *
    977 +947     -    128 +   * @example
    978 +948     -    129 +   * themeManager.saveCustomTheme({ '--h1-color': '#ff0000' });
    979 +949     -    130 +   */
    980 +950     -    131 +  saveCustomTheme(colors) {
    981 +951     -    132 +    if (!colors || typeof colors !== 'object') {
    982 +952     -    133 +      console.error('Invalid colors object');
    983 +953     -    134 +      return false;
    984 +954     -    135 +    }
    985 +955     -    136 +
    986 +956     -    137 +    return this.storage.setJSON(STORAGE_KEYS.CUSTOM_THEME, colors);
    987 +957     -    138 +  }
    988 +958     -    139 +
    989 +959     -    140 +  /**
    990 +960     -    141 +   * Get current theme name
    991 +961     -    142 +   *
    992 +962     -    143 +   * @returns {string|null} Current theme name
    993 +963     -    144 +   */
    994 +964     -    145 +  getCurrentTheme() {
    995 +965     -    146 +    return this.currentTheme;
    996 +966     -    147 +  }
    997 +967     -    148 +
    998 +968     -    149 +  /**
    999 +969     -    150 +   * Get all current theme colors
    1000 +970     -    151 +   *
    1001 +971     -    152 +   * @returns {Object} Object with CSS variable names and values
    1002 +972     -    153 +   *
    1003 +973     -    154 +   * @example
    1004 +974     -    155 +   * const colors = themeManager.getCurrentColors();
    1005 +975     -    156 +   * // { '--bg-primary': '#ffffff', '--h1-color': '#0969da', ... }
    1006 +976     -    157 +   */
    1007 +977     -    158 +  getCurrentColors() {
    1008 +978     -    159 +    const colors = {};
    1009 +979     -    160 +    const style = getComputedStyle(document.documentElement);
    1010 +980     -    161 +
    1011 +981     -    162 +    // Extract all theme-related CSS variables
    1012 +982     -    163 +    const cssVarNames = [
    1013 +983     -    164 +      '--bg-primary',
    1014 +984     -    165 +      '--bg-secondary',
    1015 +985     -    166 +      '--bg-tertiary',
    1016 +986     -    167 +      '--text-primary',
    1017 +987     -    168 +      '--text-secondary',
    1018 +988     -    169 +      '--h1-color',
    1019 +989     -    170 +      '--h2-color',
    1020 +990     -    171 +      '--h3-color',
    1021 +991     -    172 +      '--h4-color',
    1022 +992     -    173 +      '--h5-color',
    1023 +993     -    174 +      '--h6-color',
    1024 +994     -    175 +      '--link-color',
    1025 +995     -    176 +      '--bold-color',
    1026 +996     -    177 +      '--italic-color',
    1027 +997     -    178 +      '--code-text',
    1028 +998     -    179 +      '--code-bg',
    1029 +999     -    180 +      '--code-block-bg',
    1030 +1000     -    181 +      '--blockquote-border',
    1031 +1001     -    182 +    ];
    1032 +1002     -    183 +
    1033 +1003     -    184 +    cssVarNames.forEach(varName => {
    1034 +1004     -    185 +      colors[varName] = getCssVariable(varName);
    1035 +1005     -    186 +    });
    1036 +1006     -    187 +
    1037 +1007     -    188 +    return colors;
    1038 +1008     -    189 +  }
    1039 +1009     -    190 +
    1040 +1010     -    191 +  /**
    1041 +1011     -    192 +   * Clear all inline CSS variable overrides
    1042 +1012     -    193 +   * Used when switching from custom to built-in theme
    1043 +1013     -    194 +   *
    1044 +1014     -    195 +   * @private
    1045 +1015     -    196 +   */
    1046 +1016     -    197 +  clearInlineStyles() {
    1047 +1017     -    198 +    const root = document.documentElement;
    1048 +1018     -    199 +    const styles = root.style;
    1049 +1019     -    200 +
    1050 +1020     -    201 +    for (let i = styles.length - 1; i >= 0; i--) {
    1051 +1021     -    202 +      const prop = styles[i];
    1052 +1022     -    203 +      if (prop.startsWith('--')) {
    1053 +1023     -    204 +        removeCssVariable(prop);
    1054 +1024     -    205 +      }
    1055 +1025     -    206 +    }
    1056 +1026     -    207 +  }
    1057 +1027     -    208 +
    1058 +1028     -    209 +  /**
    1059 +1029     -    210 +   * Register callback for theme changes
    1060 +1030     -    211 +   *
    1061 +1031     -    212 +   * @param {Function} callback - Function to call when theme changes
    1062 +1032     -    213 +   *
    1063 +1033     -    214 +   * @example
    1064 +1034     -    215 +   * themeManager.onThemeChange = (themeName) => {
    1065 +1035     -    216 +   *   console.log('Theme changed to:', themeName);
    1066 +1036     -    217 +   *   mermaidService.reinitialize();
    1067 +1037     -    218 +   * };
    1068 +1038     -    219 +   */
    1069 +1039     -    220 +  setThemeChangeListener(callback) {
    1070 +1040     -    221 +    this.onThemeChange = callback;
    1071 +1041     -    222 +  }
    1072 +1042     -    223 +
    1073 +1043     -    224 +  /**
    1074 +1044     -    225 +   * Notify listeners of theme change
    1075 +1045     -    226 +   *
    1076 +1046     -    227 +   * @param {string} themeName - New theme name
    1077 +1047     -    228 +   * @private
    1078 +1048     -    229 +   */
    1079 +1049     -    230 +  notifyThemeChange(themeName) {
    1080 +1050     -    231 +    if (this.onThemeChange && typeof this.onThemeChange === 'function') {
    1081 +1051     -    232 +      this.onThemeChange(themeName);
    1082 +1052     -    233 +    }
    1083 +1053     -    234 +  }
    1084 +1054     -    235 +
    1085 +1055     -    236 +  /**
    1086 +1056     -    237 +   * Get list of all available themes
    1087 +1057     -    238 +   *
    1088 +1058     -    239 +   * @returns {string[]} Array of theme names
    1089 +1059     -    240 +   */
    1090 +1060     -    241 +  getAvailableThemes() {
    1091 +1061     -    242 +    return Object.values(THEMES);
    1092 +1062     -    243 +  }
    1093 +1063     -    244 +
    1094 +1064     -    245 +  /**
    1095 +1065     -    246 +   * Check if a theme exists
    1096 +1066     -    247 +   *
    1097 +1067     -    248 +   * @param {string} themeName - Theme name to check
    1098 +1068     -    249 +   * @returns {boolean} True if theme exists
    1099 +1069     -    250 +   */
    1100 +1070     -    251 +  themeExists(themeName) {
    1101 +1071     -    252 +    return isValidTheme(themeName);
    1102 +1072     -    253 +  }
    1103 +1073     -    254 +}
    1104 +1074     -    255  
    1105 +1075     -
    1106 +1076     -```
    1107 +1077     -
    1108 +1078     -
    1109 +1079     -### âœ¨ `tests/unit/core/StorageManager.test.js` **[ADDED]**
    1110 +1080     -
    1111 +1081     -**Status:** âœ… **NEW FILE** - This file has been newly created
    1112 +1082     -
    1113 +1083     -**Type:** JavaScript Source File ðŸŸ¨
    1114 +1084     -
    1115 +1085     -```diff
    1116 +1086     -@@ -0,0 +1,144 @@
    1117 +1087     -      1 +import { beforeEach, describe, expect, it } from 'vitest';
    1118 +1088     -      2 +import { StorageManager } from '../../../src/js/core/StorageManager.js';
    1119 +1089     -      3 +
    1120 +1090     -      4 +describe('StorageManager', () => {
    1121 +1091     -      5 +  let storage;
    1122 +1092     -      6 +
    1123 +1093     -      7 +  beforeEach(() => {
    1124 +1094     -      8 +    storage = new StorageManager();
    1125 +1095     -      9 +    localStorage.clear();
    1126 +1096     -     10 +  });
    1127 +1097     -     11 +
    1128 +1098     -     12 +  describe('get/set', () => {
    1129 +1099     -     13 +    it('should store and retrieve string values', () => {
    1130 +1100     -     14 +      storage.set('test-key', 'test-value');
    1131 +1101     -     15 +      expect(storage.get('test-key')).toBe('test-value');
    1132 +1102     -     16 +    });
    1133 +1103     -     17 +
    1134 +1104     -     18 +    it('should return null for non-existent key', () => {
    1135 +1105     -     19 +      expect(storage.get('non-existent')).toBeNull();
    1136 +1106     -     20 +    });
    1137 +1107     -     21 +
    1138 +1108     -     22 +    it('should return true on successful set', () => {
    1139 +1109     -     23 +      const result = storage.set('key', 'value');
    1140 +1110     -     24 +      expect(result).toBe(true);
    1141 +1111     -     25 +    });
    1142 +1112     -     26 +  });
    1143 +1113     -     27 +
    1144 +1114     -     28 +  describe('getJSON/setJSON', () => {
    1145 +1115     -     29 +    it('should store and retrieve JSON objects', () => {
    1146 +1116     -     30 +      const obj = { name: 'test', value: 123 };
    1147 +1117     -     31 +      storage.setJSON('json-key', obj);
    1148 +1118     -     32 +
    1149 +1119     -     33 +      const retrieved = storage.getJSON('json-key');
    1150 +1120     -     34 +      expect(retrieved).toEqual(obj);
    1151 +1121     -     35 +    });
    1152 +1122     -     36 +
    1153 +1123     -     37 +    it('should return null for non-existent JSON key', () => {
    1154 +1124     -     38 +      expect(storage.getJSON('non-existent')).toBeNull();
    1155 +1125     -     39 +    });
    1156 +1126     -     40 +
    1157 +1127     -     41 +    it('should handle complex nested objects', () => {
    1158 +1128     -     42 +      const complex = {
    1159 +1129     -     43 +        theme: 'dark',
    1160 +1130     -     44 +        colors: {
    1161 +1131     -     45 +          primary: '#000',
    1162 +1132     -     46 +          secondary: '#fff',
    1163 +1133     -     47 +        },
    1164 +1134     -     48 +        settings: [1, 2, 3],
    1165 +1135     -     49 +      };
    1166 +1136     -     50 +
    1167 +1137     -     51 +      storage.setJSON('complex', complex);
    1168 +1138     -     52 +      expect(storage.getJSON('complex')).toEqual(complex);
    1169 +1139     -     53 +    });
    1170 +1140     -     54 +
    1171 +1141     -     55 +    it('should return null for invalid JSON', () => {
    1172 +1142     -     56 +      localStorage.setItem('invalid-json', '{invalid}');
    1173 +1143     -     57 +      expect(storage.getJSON('invalid-json')).toBeNull();
    1174 +1144     -     58 +    });
    1175 +1145     -     59 +  });
    1176 +1146     -     60 +
    1177 +1147     -     61 +  describe('remove', () => {
    1178 +1148     -     62 +    it('should remove item from storage', () => {
    1179 +1149     -     63 +      storage.set('remove-test', 'value');
    1180 +1150     -     64 +      expect(storage.has('remove-test')).toBe(true);
    1181 +1151     -     65 +
    1182 +1152     -     66 +      storage.remove('remove-test');
    1183 +1153     -     67 +      expect(storage.has('remove-test')).toBe(false);
    1184 +1154     -     68 +    });
    1185 +1155     -     69 +
    1186 +1156     -     70 +    it('should return true on successful removal', () => {
    1187 +1157     -     71 +      storage.set('test', 'value');
    1188 +1158     -     72 +      const result = storage.remove('test');
    1189 +1159     -     73 +      expect(result).toBe(true);
    1190 +1160     -     74 +    });
    1191 +1161     -     75 +  });
    1192 +1162     -     76 +
    1193 +1163     -     77 +  describe('has', () => {
    1194 +1164     -     78 +    it('should return true for existing keys', () => {
    1195 +1165     -     79 +      storage.set('exists', 'value');
    1196 +1166     -     80 +      expect(storage.has('exists')).toBe(true);
    1197 +1167     -     81 +    });
    1198 +1168     -     82 +
    1199 +1169     -     83 +    it('should return false for non-existent keys', () => {
    1200 +1170     -     84 +      expect(storage.has('does-not-exist')).toBe(false);
    1201 +1171     -     85 +    });
    1202 +1172     -     86 +  });
    1203 +1173     -     87 +
    1204 +1174     -     88 +  describe('clear', () => {
    1205 +1175     -     89 +    it('should remove all items', () => {
    1206 +1176     -     90 +      storage.set('key1', 'value1');
    1207 +1177     -     91 +      storage.set('key2', 'value2');
    1208 +1178     -     92 +
    1209 +1179     -     93 +      storage.clear();
    1210 +1180     -     94 +
    1211 +1181     -     95 +      expect(storage.has('key1')).toBe(false);
    1212 +1182     -     96 +      expect(storage.has('key2')).toBe(false);
    1213 +1183     -     97 +    });
    1214 +1184     -     98 +
    1215 +1185     -     99 +    it('should return true on success', () => {
    1216 +1186     -    100 +      const result = storage.clear();
    1217 +1187     -    101 +      expect(result).toBe(true);
    1218 +1188     -    102 +    });
    1219 +1189     -    103 +  });
    1220 +1190     -    104 +
    1221 +1191     -    105 +  describe('getAllKeys', () => {
    1222 +1192     -    106 +    it('should return all storage keys', () => {
    1223 +1193     -    107 +      storage.set('key1', 'value1');
    1224 +1194     -    108 +      storage.set('key2', 'value2');
    1225 +1195     -    109 +
    1226 +1196     -    110 +      const keys = storage.getAllKeys();
    1227 +1197     -    111 +      // In test environment, check that method returns an array
    1228 +1198     -    112 +      expect(Array.isArray(keys)).toBe(true);
    1229 +1199     -    113 +      expect(keys.length).toBeGreaterThanOrEqual(2);
    1230 +1200     -    114 +    });
    1231 +1201     -    115 +
    1232 +1202     -    116 +    it('should return empty array when storage is empty', () => {
    1233 +1203     -    117 +      storage.clear();
    1234 +1204     -    118 +      const keys = storage.getAllKeys();
    1235 +1205     -    119 +      expect(Array.isArray(keys)).toBe(true);
    1236 +1206     -    120 +    });
    1237 +1207     -    121 +  });
    1238 +1208     -    122 +
    1239 +1209     -    123 +  describe('getSize', () => {
    1240 +1210     -    124 +    it('should calculate approximate storage size', () => {
    1241 +1211     -    125 +      storage.set('test', 'value');
    1242 +1212     -    126 +      const size = storage.getSize();
    1243 +1213     -    127 +
    1244 +1214     -    128 +      expect(size).toBeGreaterThan(0);
    1245 +1215     -    129 +      expect(typeof size).toBe('number');
    1246 +1216     -    130 +    });
    1247 +1217     -    131 +
    1248 +1218     -    132 +    it('should return 0 for empty storage', () => {
    1249 +1219     -    133 +      storage.clear();
    1250 +1220     -    134 +      const size = storage.getSize();
    1251 +1221     -    135 +      expect(size).toBeGreaterThanOrEqual(0);
    1252 +1222     -    136 +    });
    1253 +1223     -    137 +  });
    1254 +1224     -    138 +
    1255 +1225     -    139 +  describe('isAvailable', () => {
    1256 +1226     -    140 +    it('should return true when localStorage is available', () => {
    1257 +1227     -    141 +      expect(storage.isAvailable()).toBe(true);
    1258 +1228     -    142 +    });
    1259 +1229     -    143 +  });
    1260 +1230     -    144 +});
    1261 +1231     -    145  
    1262 +1232     -
    1263 +1233     -```
    1264 +1234     -
    1265 +1235     -
    1266 +1236     -### âœ¨ `tests/unit/core/ThemeManager.test.js` **[ADDED]**
    1267 +1237     -
    1268 +1238     -**Status:** âœ… **NEW FILE** - This file has been newly created
    1269 +1239     -
    1270 +1240     -**Type:** JavaScript Source File ðŸŸ¨
    1271 +1241     -
    1272 +1242     -```diff
    1273 +1243     -@@ -0,0 +1,150 @@
    1274 +1244     -      1 +import { beforeEach, describe, expect, it, vi } from 'vitest';
    1275 +1245     -      2 +import { ThemeManager } from '../../../src/js/core/ThemeManager.js';
    1276 +1246     -      3 +
    1277 +1247     -      4 +describe('ThemeManager', () => {
    1278 +1248     -      5 +  let themeManager;
    1279 +1249     -      6 +  let mockStorage;
    1280 +1250     -      7 +  let mockStylesheet;
    1281 +     24 +  3     -// Import constants and utilities
    1282 +     25 +      3 +// Import constants, utilities, services, and core modules
    1283 +     26 +      4 +import { StorageManager } from './src/js/core/StorageManager.js';
    1284 +     27 +      5 +import { ThemeManager } from './src/js/core/ThemeManager.js';
    1285 +     28 +      6 +import { MermaidService } from './src/js/services/MermaidService.js';
    1286 +     29 +      7 +import { PrismService } from './src/js/services/PrismService.js';
    1287 +1251  30        8 +
    1288 +1252     -      9 +  beforeEach(() => {
    1289 +1253     -     10 +    // Mock StorageManager
    1290 +1254     -     11 +    mockStorage = {
    1291 +1255     -     12 +      get: vi.fn(),
    1292 +1256     -     13 +      set: vi.fn().mockReturnValue(true),
    1293 +1257     -     14 +      getJSON: vi.fn(),
    1294 +1258     -     15 +      setJSON: vi.fn().mockReturnValue(true),
    1295 +1259     -     16 +    };
    1296 +1260     -     17 +
    1297 +1261     -     18 +    // Mock theme stylesheet element
    1298 +1262     -     19 +    mockStylesheet = { href: '' };
    1299 +1263     -     20 +    vi.spyOn(document, 'getElementById').mockReturnValue(mockStylesheet);
    1300 +1264     -     21 +
    1301 +1265     -     22 +    themeManager = new ThemeManager(mockStorage);
    1302 +1266     -     23 +  });
    1303 +1267     -     24 +
    1304 +1268     -     25 +  describe('loadTheme', () => {
    1305 +1269     -     26 +    it('should load built-in theme successfully', async () => {
    1306 +1270     -     27 +      const result = await themeManager.loadTheme('ocean-dark');
    1307 +1271     -     28 +
    1308 +1272     -     29 +      expect(result).toBe(true);
    1309 +1273     -     30 +      expect(mockStorage.set).toHaveBeenCalledWith('selectedTheme', 'ocean-dark');
    1310 +1274     -     31 +      expect(mockStylesheet.href).toContain('ocean-dark');
    1311 +1275     -     32 +    });
    1312 +1276     -     33 +
    1313 +1277     -     34 +    it('should throw error for invalid theme', async () => {
    1314 +1278     -     35 +      await expect(themeManager.loadTheme('invalid-theme')).rejects.toThrow('Invalid theme');
    1315 +1279     -     36 +    });
    1316 +1280     -     37 +
    1317 +1281     -     38 +    it('should load custom theme when specified', async () => {
    1318 +1282     -     39 +      const customColors = { '--h1-color': '#ff0000' };
    1319 +1283     -     40 +      mockStorage.getJSON.mockReturnValue(customColors);
    1320 +1284     -     41 +
    1321 +1285     -     42 +      const result = await themeManager.loadTheme('custom');
    1322 +1286     -     43 +
    1323 +1287     -     44 +      expect(result).toBe(true);
    1324 +1288     -     45 +      expect(mockStorage.getJSON).toHaveBeenCalledWith('customTheme');
    1325 +1289     -     46 +    });
    1326 +1290     -     47 +
    1327 +1291     -     48 +    it('should fallback to default if custom theme not found', async () => {
    1328 +1292     -     49 +      mockStorage.getJSON.mockReturnValue(null);
    1329 +1293     -     50 +
    1330 +1294     -     51 +      const result = await themeManager.loadTheme('custom');
    1331 +1295     -     52 +
    1332 +1296     -     53 +      expect(mockStylesheet.href).toContain('default-light');
    1333 +1297     -     54 +    });
    1334 +1298     -     55 +  });
    1335 +1299     -     56 +
    1336 +1300     -     57 +  describe('saveCustomTheme', () => {
    1337 +1301     -     58 +    it('should save custom theme colors', () => {
    1338 +1302     -     59 +      const colors = { '--h1-color': '#00ff00' };
    1339 +1303     -     60 +
    1340 +1304     -     61 +      const result = themeManager.saveCustomTheme(colors);
    1341 +1305     -     62 +
    1342 +1306     -     63 +      expect(result).toBe(true);
    1343 +1307     -     64 +      expect(mockStorage.setJSON).toHaveBeenCalledWith('customTheme', colors);
    1344 +1308     -     65 +    });
    1345 +1309     -     66 +
    1346 +1310     -     67 +    it('should reject invalid colors object', () => {
    1347 +1311     -     68 +      const result = themeManager.saveCustomTheme(null);
    1348 +1312     -     69 +
    1349 +1313     -     70 +      expect(result).toBe(false);
    1350 +1314     -     71 +      expect(mockStorage.setJSON).not.toHaveBeenCalled();
    1351 +1315     -     72 +    });
    1352 +1316     -     73 +
    1353 +1317     -     74 +    it('should reject non-object colors', () => {
    1354 +1318     -     75 +      const result = themeManager.saveCustomTheme('not-an-object');
    1355 +1319     -     76 +
    1356 +1320     -     77 +      expect(result).toBe(false);
    1357 +1321     -     78 +    });
    1358 +1322     -     79 +  });
    1359 +1323     -     80 +
    1360 +1324     -     81 +  describe('getCurrentTheme', () => {
    1361 +1325     -     82 +    it('should return current theme name', async () => {
    1362 +1326     -     83 +      await themeManager.loadTheme('neon-dark');
    1363 +1327     -     84 +
    1364 +1328     -     85 +      expect(themeManager.getCurrentTheme()).toBe('neon-dark');
    1365 +1329     -     86 +    });
    1366 +1330     -     87 +
    1367 +1331     -     88 +    it('should return null initially', () => {
    1368 +1332     -     89 +      expect(themeManager.getCurrentTheme()).toBeNull();
    1369 +1333     -     90 +    });
    1370 +1334     -     91 +  });
    1371 +1335     -     92 +
    1372 +1336     -     93 +  describe('getCurrentColors', () => {
    1373 +1337     -     94 +    it('should extract all current CSS variables', () => {
    1374 +1338     -     95 +      const colors = themeManager.getCurrentColors();
    1375 +1339     -     96 +
    1376 +1340     -     97 +      expect(colors).toHaveProperty('--bg-primary');
    1377 +1341     -     98 +      expect(colors).toHaveProperty('--h1-color');
    1378 +1342     -     99 +      expect(colors).toHaveProperty('--text-primary');
    1379 +1343     -    100 +    });
    1380 +1344     -    101 +
    1381 +1345     -    102 +    it('should return object with color values', () => {
    1382 +1346     -    103 +      const colors = themeManager.getCurrentColors();
    1383 +1347     -    104 +
    1384 +1348     -    105 +      expect(typeof colors).toBe('object');
    1385 +1349     -    106 +      expect(Object.keys(colors).length).toBeGreaterThan(0);
    1386 +1350     -    107 +    });
    1387 +1351     -    108 +  });
    1388 +1352     -    109 +
    1389 +1353     -    110 +  describe('setThemeChangeListener', () => {
    1390 +1354     -    111 +    it('should register theme change callback', async () => {
    1391 +1355     -    112 +      const callback = vi.fn();
    1392 +1356     -    113 +      themeManager.setThemeChangeListener(callback);
    1393 +1357     -    114 +
    1394 +1358     -    115 +      await themeManager.loadTheme('forest-dark');
    1395 +1359     -    116 +
    1396 +1360     -    117 +      expect(callback).toHaveBeenCalledWith('forest-dark');
    1397 +1361     -    118 +    });
    1398 +1362     -    119 +
    1399 +1363     -    120 +    it('should not throw if callback is null', async () => {
    1400 +1364     -    121 +      themeManager.setThemeChangeListener(null);
    1401 +1365     -    122 +
    1402 +1366     -    123 +      await expect(themeManager.loadTheme('ocean-light')).resolves.toBe(true);
    1403 +1367     -    124 +    });
    1404 +1368     -    125 +  });
    1405 +1369     -    126 +
    1406 +1370     -    127 +  describe('getAvailableThemes', () => {
    1407 +1371     -    128 +    it('should return list of all themes', () => {
    1408 +1372     -    129 +      const themes = themeManager.getAvailableThemes();
    1409 +1373     -    130 +
    1410 +1374     -    131 +      expect(themes).toContain('default-light');
    1411 +1375     -    132 +      expect(themes).toContain('ocean-dark');
    1412 +1376     -    133 +      expect(themes).toContain('obsidian-dark');
    1413 +1377     -    134 +      expect(themes).toContain('custom');
    1414 +1378     -    135 +      expect(themes.length).toBe(13);
    1415 +1379     -    136 +    });
    1416 +1380     -    137 +  });
    1417 +1381     -    138 +
    1418 +1382     -    139 +  describe('themeExists', () => {
    1419 +1383     -    140 +    it('should return true for valid themes', () => {
    1420 +1384     -    141 +      expect(themeManager.themeExists('default-dark')).toBe(true);
    1421 +1385     -    142 +      expect(themeManager.themeExists('obsidian-light')).toBe(true);
    1422 +1386     -    143 +    });
    1423 +1387     -    144 +
    1424 +1388     -    145 +    it('should return false for invalid themes', () => {
    1425 +1389     -    146 +      expect(themeManager.themeExists('invalid')).toBe(false);
    1426 +1390     -    147 +      expect(themeManager.themeExists('')).toBe(false);
    1427 +1391     -    148 +    });
    1428 +1392     -    149 +  });
    1429 +1393     -    150 +});
    1430 +1394     -    151  
    1431 +     31 +      9 +// Initialize services and managers (but don't use yet - feature flags OFF)
    1432 +     32 +     10 +const storageManager = new StorageManager();
    1433 +     33 +     11 +const themeManager = new ThemeManager(storageManager);
    1434 +     34 +     12 +const mermaidService = new MermaidService();
    1435 +     35 +     13 +const prismService = new PrismService();
    1436 +     36 +  4  14  
    1437 +     37 +  5  15  // Wait for all scripts to load
    1438 +     38 +  6  16  window.addEventListener('DOMContentLoaded', function () {
    1439 +     39 +  7  17  
    1440 +1395  40  
    1441 +1396  41  ```
    1442 +1397  42  
    1443 +@@ -1437,4 +82,4 @@ Please provide specific feedback on:
    1444 +1437  82  
    1445 +1438  83  ---
    1446 +1439  84  *Generated by AI Visual Code Review v2.0 - Unified Export Script*
    1447 +1440     -*Files processed: 5/5 | Errors: 0 | Generated: 2025-11-08T13:13:07.499Z*
    1448 +     85 +*Files processed: 1/1 | Errors: 0 | Generated: 2025-11-09T09:54:13.727Z*
    1449 +1441  86  
    1450 +
    1451 +```
 14 1452  
 15 1453  
 16 1454  ### ðŸ“„ `script.js`
@@ -18,25 +1456,99 @@ script.js | 12 +++++++++++-
 18 1456  **Type:** JavaScript Source File ðŸŸ¨
 19 1457  
 20 1458  ```diff
 21     -@@ -1,6 +1,16 @@
 22     -  1   1  // Markdown Viewer Pro - Main Script
 23     -  2   2  
 24     -  3     -// Import constants and utilities
 25     -      3 +// Import constants, utilities, services, and core modules
 26     -      4 +import { StorageManager } from './src/js/core/StorageManager.js';
 27     -      5 +import { ThemeManager } from './src/js/core/ThemeManager.js';
 28     -      6 +import { MermaidService } from './src/js/services/MermaidService.js';
 29     -      7 +import { PrismService } from './src/js/services/PrismService.js';
 30     -      8 +
 31     -      9 +// Initialize services and managers (but don't use yet - feature flags OFF)
 32     -     10 +const storageManager = new StorageManager();
 33     -     11 +const themeManager = new ThemeManager(storageManager);
 34     -     12 +const mermaidService = new MermaidService();
 35     -     13 +const prismService = new PrismService();
 36     -  4  14  
 37     -  5  15  // Wait for all scripts to load
 38     -  6  16  window.addEventListener('DOMContentLoaded', function () {
 39     -  7  17  
    1459 +@@ -6,12 +6,17 @@ import { ThemeManager } from './src/js/core/ThemeManager.js';
    1460 +  6   6  import { MermaidService } from './src/js/services/MermaidService.js';
    1461 +  7   7  import { PrismService } from './src/js/services/PrismService.js';
    1462 +  8   8  
    1463 +  9     -// Initialize services and managers (but don't use yet - feature flags OFF)
    1464 +      9 +// Initialize services and managers - NOW ACTIVELY USED
    1465 + 10  10  const storageManager = new StorageManager();
    1466 + 11  11  const themeManager = new ThemeManager(storageManager);
    1467 + 12  12  const mermaidService = new MermaidService();
    1468 + 13  13  const prismService = new PrismService();
    1469 + 14  14  
    1470 +     15 +// Configure theme change listener to update Mermaid
    1471 +     16 +themeManager.setThemeChangeListener(() => {
    1472 +     17 +  mermaidService.reinitialize();
    1473 +     18 +});
    1474 +     19 +
    1475 + 15  20  // Wait for all scripts to load
    1476 + 16  21  window.addEventListener('DOMContentLoaded', function () {
    1477 + 17  22    initializeApp();
    1478 +@@ -35,55 +40,9 @@ function initializeApp() {
    1479 + 35  40    setupEditor();
    1480 + 36  41  }
    1481 + 37  42  
    1482 + 38     -// Initialize Mermaid with theme-aware colors
    1483 +     43 +// Initialize Mermaid using MermaidService
    1484 + 39  44  function initMermaidTheme() {
    1485 + 40     -  const isDark =
    1486 + 41     -    getComputedStyle(document.documentElement)
    1487 + 42     -      .getPropertyValue('--bg-primary')
    1488 + 43     -      .trim()
    1489 + 44     -      .startsWith('#0') ||
    1490 + 45     -    getComputedStyle(document.documentElement)
    1491 + 46     -      .getPropertyValue('--bg-primary')
    1492 + 47     -      .trim()
    1493 + 48     -      .startsWith('#1') ||
    1494 + 49     -    getComputedStyle(document.documentElement)
    1495 + 50     -      .getPropertyValue('--bg-primary')
    1496 + 51     -      .trim()
    1497 + 52     -      .startsWith('#2');
    1498 + 53     -
    1499 + 54     -  const h1Color = getComputedStyle(document.documentElement).getPropertyValue('--h1-color').trim();
    1500 + 55     -  const h2Color = getComputedStyle(document.documentElement).getPropertyValue('--h2-color').trim();
    1501 + 56     -  const h3Color = getComputedStyle(document.documentElement).getPropertyValue('--h3-color').trim();
    1502 + 57     -  const bgSecondary = getComputedStyle(document.documentElement)
    1503 + 58     -    .getPropertyValue('--bg-secondary')
    1504 + 59     -    .trim();
    1505 + 60     -  const textPrimary = getComputedStyle(document.documentElement)
    1506 + 61     -    .getPropertyValue('--text-primary')
    1507 + 62     -    .trim();
    1508 + 63     -
    1509 + 64     -  mermaid.initialize({
    1510 + 65     -    startOnLoad: false,
    1511 + 66     -    theme: 'base',
    1512 + 67     -    themeVariables: {
    1513 + 68     -      primaryColor: bgSecondary,
    1514 + 69     -      primaryTextColor: textPrimary,
    1515 + 70     -      primaryBorderColor: h1Color,
    1516 + 71     -      lineColor: h2Color,
    1517 + 72     -      secondaryColor: bgSecondary,
    1518 + 73     -      tertiaryColor: bgSecondary,
    1519 + 74     -      background: bgSecondary,
    1520 + 75     -      mainBkg: bgSecondary,
    1521 + 76     -      secondBkg: bgSecondary,
    1522 + 77     -      tertiaryBkg: bgSecondary,
    1523 + 78     -      nodeBorder: h1Color,
    1524 + 79     -      clusterBkg: bgSecondary,
    1525 + 80     -      clusterBorder: h3Color,
    1526 + 81     -      titleColor: textPrimary,
    1527 + 82     -      edgeLabelBackground: bgSecondary,
    1528 + 83     -      nodeTextColor: textPrimary,
    1529 + 84     -      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
    1530 + 85     -    },
    1531 + 86     -  });
    1532 +     45 +  mermaidService.initialize();
    1533 + 87  46  }
    1534 + 88  47  
    1535 + 89  48  function setupEditor() {
    1536 +@@ -249,12 +208,8 @@ graph TD
    1537 +249 208  
    1538 +250 209        preview.innerHTML = html;
    1539 +251 210  
    1540 +252     -      // Apply Prism syntax highlighting
    1541 +253     -      if (typeof Prism !== 'undefined') {
    1542 +254     -        preview.querySelectorAll('pre code').forEach(block => {
    1543 +255     -          Prism.highlightElement(block);
    1544 +256     -        });
    1545 +257     -      }
    1546 +    211 +      // Apply Prism syntax highlighting using PrismService
    1547 +    212 +      prismService.highlightAll(preview);
    1548 +258 213  
    1549 +259 214        // Save content
    1550 +260 215        localStorage.setItem('markdownContent', markdownText);
    1551 +261 216  
 40 1552  
 41 1553  ```
 42 1554  
@@ -82,4 +1594,4 @@ Please provide specific feedback on:
 82 1594  
 83 1595  ---
 84 1596  *Generated by AI Visual Code Review v2.0 - Unified Export Script*
 85     -*Files processed: 1/1 | Errors: 0 | Generated: 2025-11-09T09:54:13.727Z*
    1597 +*Files processed: 2/2 | Errors: 0 | Generated: 2025-11-09T09:59:32.923Z*
 86 1598  

```


### ðŸ“„ `script.js`

**Type:** JavaScript Source File ðŸŸ¨

```diff
@@ -160,8 +160,8 @@ graph TD
160 160    const zoomLevelDisplay = document.getElementById('zoom-level');
161 161    let currentZoom = 100; // Default zoom level
162 162  
163     -  // Set default content
164     -  const savedContent = localStorage.getItem('markdownContent');
    163 +  // Set default content using StorageManager
    164 +  const savedContent = storageManager.get('markdownContent');
165 165    editor.value = savedContent || defaultMarkdown;
166 166  
167 167    // Helper function to decode HTML entities
@@ -211,8 +211,8 @@ graph TD
211 211        // Apply Prism syntax highlighting using PrismService
212 212        prismService.highlightAll(preview);
213 213  
214     -      // Save content
215     -      localStorage.setItem('markdownContent', markdownText);
    214 +      // Save content using StorageManager
    215 +      storageManager.set('markdownContent', markdownText);
216 216      } catch (error) {
217 217        console.error('Render error:', error);
218 218        preview.innerHTML =
@@ -220,36 +220,13 @@ graph TD
220 220      }
221 221    }
222 222  
223     -  // Change theme
224     -  function changeTheme(themeName) {
225     -    if (themeName === 'custom') {
226     -      const customTheme = localStorage.getItem('customTheme');
227     -      if (customTheme) {
228     -        const theme = JSON.parse(customTheme);
229     -        Object.entries(theme).forEach(([property, value]) => {
230     -          document.documentElement.style.setProperty(property, value);
231     -        });
232     -      }
233     -    } else {
234     -      // Remove inline styles
235     -      const root = document.documentElement;
236     -      const styles = root.style;
237     -      for (let i = styles.length - 1; i >= 0; i--) {
238     -        const prop = styles[i];
239     -        if (prop.startsWith('--')) {
240     -          root.style.removeProperty(prop);
241     -        }
242     -      }
    223 +  // Change theme using ThemeManager
    224 +  async function changeTheme(themeName) {
    225 +    await themeManager.loadTheme(themeName);
243 226  
244     -      // Load theme stylesheet
245     -      themeStylesheet.href = `themes/${themeName}.css`;
246     -    }
247     -    localStorage.setItem('selectedTheme', themeName);
248     -
249     -    // Reinitialize Mermaid with new theme colors
    227 +    // Re-render to apply new Mermaid theme (observer already handles reinit)
250 228      setTimeout(() => {
251     -      initMermaidTheme();
252     -      renderMarkdown(); // Re-render to apply new Mermaid theme
    229 +      renderMarkdown();
253 230      }, 100);
254 231    }
255 232  
@@ -279,9 +256,9 @@ graph TD
279 256      let themeCSS = '';
280 257  
281 258      if (currentTheme === 'custom') {
282     -      const customTheme = localStorage.getItem('customTheme');
    259 +      const customTheme = storageManager.getJSON('customTheme');
283 260        if (customTheme) {
284     -        const theme = JSON.parse(customTheme);
    261 +        const theme = customTheme;
285 262          themeCSS = ':root {\n';
286 263          Object.entries(theme).forEach(([property, value]) => {
287 264            themeCSS += `    ${property}: ${value};\n`;
@@ -373,8 +350,8 @@ graph TD
373 350    // Event Listeners
374 351    editor.addEventListener('input', renderMarkdown);
375 352  
376     -  themeSelector.addEventListener('change', e => {
377     -    changeTheme(e.target.value);
    353 +  themeSelector.addEventListener('change', async e => {
    354 +    await changeTheme(e.target.value);
378 355    });
379 356  
380 357    customizeBtn.addEventListener('click', () => {
@@ -392,21 +369,25 @@ graph TD
392 369      }
393 370    });
394 371  
395     -  resetBtn.addEventListener('click', () => {
    372 +  resetBtn.addEventListener('click', async () => {
396 373      const currentTheme = themeSelector.value === 'custom' ? 'default-light' : themeSelector.value;
397     -    changeTheme(currentTheme);
    374 +    await changeTheme(currentTheme);
398 375      initColorInputs();
399 376    });
400 377  
401     -  saveThemeBtn.addEventListener('click', () => {
    378 +  saveThemeBtn.addEventListener('click', async () => {
402 379      const customTheme = {};
403 380      document.querySelectorAll('.color-control input[type="color"]').forEach(input => {
404 381        const varName = input.dataset.var;
405 382        customTheme[varName] = input.value;
406 383      });
407     -    localStorage.setItem('customTheme', JSON.stringify(customTheme));
    384 +
    385 +    // Save and load custom theme using ThemeManager
    386 +    themeManager.saveCustomTheme(customTheme);
    387 +    await themeManager.loadTheme('custom');
408 388      themeSelector.value = 'custom';
409     -    alert('Custom theme saved! Select "Custom Theme" from the dropdown to use it.');
    389 +
    390 +    alert('Custom theme saved and applied!');
410 391      modal.classList.remove('active');
411 392    });
412 393  
@@ -511,7 +492,7 @@ graph TD
511 492      }
512 493  
513 494      // Save view mode preference
514     -    localStorage.setItem('viewMode', mode);
    495 +    storageManager.set('viewMode', mode);
515 496    }
516 497  
517 498    // View mode button event listeners
@@ -519,11 +500,14 @@ graph TD
519 500    splitViewBtn.addEventListener('click', () => setViewMode('split-view'));
520 501    previewOnlyBtn.addEventListener('click', () => setViewMode('preview-only'));
521 502  
522     -  // Load saved theme
523     -  const savedTheme = localStorage.getItem('selectedTheme');
    503 +  // Load saved theme using ThemeManager
    504 +  const savedTheme = storageManager.get('selectedTheme');
524 505    if (savedTheme) {
525 506      themeSelector.value = savedTheme;
526     -    changeTheme(savedTheme);
    507 +    themeManager.loadTheme(savedTheme).catch(err => {
    508 +      console.error('Failed to load saved theme:', err);
    509 +      themeManager.loadTheme('default-light');
    510 +    });
527 511    }
528 512  
529 513    // Zoom functionality
@@ -547,7 +531,7 @@ graph TD
547 531      zoomLevelDisplay.textContent = `${currentZoom}%`;
548 532  
549 533      // Save to localStorage
550     -    localStorage.setItem('previewZoom', currentZoom.toString());
    534 +    storageManager.set('previewZoom', currentZoom.toString());
551 535    }
552 536  
553 537    function zoomIn() {
@@ -595,14 +579,14 @@ graph TD
595 579    });
596 580  
597 581    // Load saved zoom level
598     -  const savedZoom = localStorage.getItem('previewZoom');
    582 +  const savedZoom = storageManager.get('previewZoom');
599 583    if (savedZoom) {
600 584      currentZoom = parseInt(savedZoom, 10);
601 585      setZoom(currentZoom);
602 586    }
603 587  
604 588    // Load saved view mode
605     -  const savedViewMode = localStorage.getItem('viewMode') || 'split-view';
    589 +  const savedViewMode = storageManager.get('viewMode') || 'split-view';
606 590    setViewMode(savedViewMode);
607 591  
608 592    // Initial render
609 593  

```

---

## ðŸ¤– AI Review Checklist

Please review these changes for:

### ðŸ” Code Quality
- [ ] **Linting Compliance**: No unused imports/variables, proper formatting
- [ ] **Type Safety**: Proper typing throughout (TypeScript/Python type hints)
- [ ] **Best Practices**: Framework-specific conventions and patterns
- [ ] **Performance**: Efficient algorithms, proper memoization
- [ ] **Documentation**: Clear comments and function descriptions

### ðŸ› Potential Issues
- [ ] **Runtime Errors**: Type mismatches, null/undefined handling
- [ ] **Logic Bugs**: Incorrect calculations, edge cases
- [ ] **Memory Leaks**: Cleanup in lifecycle methods, event listeners
- [ ] **Error Handling**: Proper try-catch blocks, user feedback
- [ ] **Accessibility**: ARIA labels, keyboard navigation, screen readers

### ðŸ”’ Security & Data
- [ ] **Input Validation**: Sanitization, XSS prevention, SQL injection
- [ ] **Authentication**: Proper access controls and permissions
- [ ] **Privacy**: No sensitive data exposure in logs/client
- [ ] **Dependencies**: Updated packages, vulnerability checks

### ðŸ“± UX/UI
- [ ] **Responsive Design**: Mobile/desktop/tablet compatibility
- [ ] **Loading States**: Proper feedback during async operations
- [ ] **Error Messages**: User-friendly error handling and recovery
- [ ] **Performance**: Fast loading, smooth animations

### ðŸ’¡ Suggestions & Improvements
Please provide specific feedback on:
1. Code organization and structure improvements
2. Performance optimization opportunities
3. Security considerations and hardening
4. Testing coverage and strategies
5. Documentation and maintainability

---
*Generated by AI Visual Code Review v2.0 - Unified Export Script*
*Files processed: 2/2 | Errors: 0 | Generated: 2025-11-09T10:11:57.307Z*
