# ðŸ” Code Review - 12/9/2025, 7:05:49 AM

**Project:** AI Visual Code Review
**Generated by:** AI Visual Code Review v2.0

## ðŸ“Š Change Summary

```
AI_REVIEW.md | 14895 ++++++++++++++++++++++++++++++++++++++-------------------
 script.js    |  1463 +++---
 2 files changed, 10790 insertions(+), 5568 deletions(-)
```

## ðŸ“ Files Changed (1/2 selected)

### ðŸ“¦ Large Files Skipped
The following files were skipped due to size (use --no-size-limit to include):
- `AI_REVIEW.md`


### ðŸ“„ `script.js`

**Type:** JavaScript Source File ðŸŸ¨

```diff
@@ -1,13 +1,13 @@
  1   1  // Markdown Viewer Pro - Main Script
  2   2  
  3   3  // Import constants, utilities, services, and core modules
      4 +import DOMPurify from 'dompurify';
  4   5  import { StorageManager } from './src/js/core/StorageManager.js';
  5   6  import { ThemeManager } from './src/js/core/ThemeManager.js';
  6   7  import { FolderBrowserService } from './src/js/services/FolderBrowserService.js';
  7   8  import { MermaidService } from './src/js/services/MermaidService.js';
  8   9  import { PDFService } from './src/js/services/PDFService.js';
  9  10  import { PrismService } from './src/js/services/PrismService.js';
 10     -import DOMPurify from 'dompurify';
 11  11  
 12  12  // Initialize services and managers
 13  13  const storageManager = new StorageManager();
@@ -29,12 +29,11 @@ themeManager.setThemeChangeListener(() => {
 29  29    mermaidService.reinitialize();
 30  30  
 31  31    // Force re-render of markdown to apply new Mermaid colors
 32     -  setTimeout(() => {
 33     -    if (globalRenderMarkdown) {
 34     -      console.log('ðŸ”„ Re-rendering diagrams with new theme colors');
 35     -      globalRenderMarkdown();
 36     -    }
 37     -  }, 200);
     32 +  // No timeout needed - waiting for next microtask is sufficient
     33 +  if (globalRenderMarkdown) {
     34 +    console.log('ðŸ”„ Re-rendering diagrams with new theme colors');
     35 +    globalRenderMarkdown();
     36 +  }
 38  37  });
 39  38  
 40  39  // Wait for all scripts to load
@@ -498,134 +497,120 @@ graph TD
498 497        // Parse markdown with all extensions
499 498        let html = marked.parse(markdownText);
500 499  
501     -      // Replace mermaid code blocks
    500 +      // Replace mermaid code blocks with placeholders
502 501        html = html.replace(
503 502          /<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g,
504 503          (match, code) => {
505     -          // Decode HTML entities before passing to Mermaid
506 504            const decodedCode = decodeHtmlEntities(code);
507 505            const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
508     -          setTimeout(() => {
509     -            try {
510     -              const element = document.getElementById(id);
511     -              if (element && typeof mermaid !== 'undefined') {
512     -                mermaid
513     -                  .render('mermaid-svg-' + id, decodedCode)
514     -                  .then(result => {
515     -                    element.innerHTML = result.svg;
516     -                  })
517     -                  .catch(err => {
518     -                    element.innerHTML =
519     -                      '<p style="color: red;">Mermaid diagram error: ' + err.message + '</p>';
520     -                  });
521     -              }
522     -            } catch (e) {
523     -              console.error('Mermaid render error:', e);
524     -            }
525     -          }, 100);
526     -          return `<div class="mermaid" id="${id}">${code}</div>`;
527     -        }
    506 +          // Return placeholder div
    507 +          return `<div class="mermaid" id="${id}" data-code="${encodeURIComponent(decodedCode)}">${code}</div>`;
528 508          }
529 509        );
530 510  
531     -    // Sanitize HTML using DOMPurify
532     -    // Allow SVG for Mermaid diagrams and math classes
533     -    const cleanHtml = DOMPurify.sanitize(html, {
534     -      ADD_TAGS: ['iframe'], // Allow iframes for PDF preview if needed
535     -      ADD_ATTR: ['allow', 'allowfullscreen', 'frameborder', 'scrolling', 'target'],
536     -      USE_PROFILES: { html: true, svg: true, mathml: true },
537     -    });
538     -
539     -    preview.innerHTML = cleanHtml;
540     -
541     -    // Apply Prism syntax highlighting using PrismService
542     -    prismService.highlightAll(preview);
543     -
544     -    // NOTE: KaTeX auto-render is DISABLED
545     -    // We handle all math via marked.js extensions ($...$ and $$...$$)
546     -    // KaTeX auto-render was causing issues with unsupported LaTeX environments
547     -
548     -    // Save content using StorageManager
549     -    storageManager.set('markdownContent', markdownText);
550     -  } catch (error) {
551     -    console.error('Render error:', error);
552     -    preview.innerHTML =
553     -      '<p style="color: red;">Error rendering markdown: ' + error.message + '</p>';
554     -  }
555     -}
556     -
557     -// Change theme using ThemeManager
558     -async function changeTheme(themeName) {
559     -  await themeManager.loadTheme(themeName);
560     -
561     -  // Wait for theme to load, then reinitialize Mermaid and force re-render
562     -  setTimeout(() => {
563     -    // Clear existing Mermaid diagrams to force fresh render with new colors
564     -    const mermaidElements = preview.querySelectorAll('.mermaid');
565     -    mermaidElements.forEach(el => {
566     -      // Reset to original code to force re-render
567     -      el.innerHTML = el.dataset.originalCode || '';
568     -    });
569     -
570     -    // Re-render markdown with new theme
571     -    renderMarkdown();
572     -  }, 100);
573     -}
574     -
575     -// Initialize color inputs
576     -function initColorInputs() {
577     -  document.querySelectorAll('.color-control input[type="color"]').forEach(input => {
578     -    const varName = input.dataset.var;
579     -    const textInput = document.getElementById(input.id + '-text');
580     -    const currentValue = getComputedStyle(document.documentElement)
581     -      .getPropertyValue(varName)
582     -      .trim();
583     -
584     -    input.value = currentValue;
585     -    textInput.value = currentValue;
586     -
587     -    input.addEventListener('input', e => {
588     -      const color = e.target.value;
589     -      document.documentElement.style.setProperty(varName, color);
590     -      textInput.value = color;
591     -    });
592     -  });
593     -}
594     -
595     -// Export to HTML
596     -function exportHTML() {
597     -  const currentTheme = themeSelector.value;
598     -  let themeCSS = '';
599     -
600     -  if (currentTheme === 'custom') {
601     -    const customTheme = storageManager.getJSON('customTheme');
602     -    if (customTheme) {
603     -      const theme = customTheme;
604     -      themeCSS = ':root {\n';
605     -      Object.entries(theme).forEach(([property, value]) => {
606     -        themeCSS += `    ${property}: ${value};\n`;
    511 +      // Sanitize HTML using DOMPurify
    512 +      const cleanHtml = DOMPurify.sanitize(html, {
    513 +        ADD_TAGS: ['iframe'],
    514 +        ADD_ATTR: ['allow', 'allowfullscreen', 'frameborder', 'scrolling', 'target', 'data-code'], // Add data-code
    515 +        USE_PROFILES: { html: true, svg: true, mathml: true },
607 516        });
608     -      themeCSS += '}';
    517 +
    518 +      preview.innerHTML = cleanHtml;
    519 +
    520 +      // Render Mermaid diagrams synchronously after DOM update
    521 +      const mermaidElements = preview.querySelectorAll('.mermaid');
    522 +      mermaidElements.forEach(element => {
    523 +        const id = element.id;
    524 +        const code = decodeURIComponent(element.dataset.code);
    525 +
    526 +        if (typeof mermaid !== 'undefined') {
    527 +          mermaid
    528 +            .render('mermaid-svg-' + id, code)
    529 +            .then(result => {
    530 +              element.innerHTML = result.svg;
    531 +            })
    532 +            .catch(err => {
    533 +              element.innerHTML = `<p style="color: red;">Mermaid diagram error: ${err.message}</p>`;
    534 +            });
    535 +        }
    536 +      });
    537 +
    538 +      // Apply Prism syntax highlighting using PrismService
    539 +      prismService.highlightAll(preview);
    540 +
    541 +      // NOTE: KaTeX auto-render is DISABLED
    542 +      // We handle all math via marked.js extensions ($...$ and $$...$$)
    543 +      // KaTeX auto-render was causing issues with unsupported LaTeX environments
    544 +
    545 +      // Save content using StorageManager
    546 +      storageManager.set('markdownContent', markdownText);
    547 +    } catch (error) {
    548 +      console.error('Render error:', error);
    549 +      preview.innerHTML =
    550 +        '<p style="color: red;">Error rendering markdown: ' + error.message + '</p>';
609 551      }
610     -  } else {
611     -    // Fetch theme CSS
612     -    fetch(`themes/${currentTheme}.css`)
613     -      .then(response => response.text())
614     -      .then(css => {
615     -        themeCSS = css;
616     -        generateHTML();
617     -      })
618     -      .catch(err => {
619     -        console.error('Error loading theme:', err);
620     -        generateHTML();
621     -      });
622     -    return;
623 552    }
624 553  
625     -  generateHTML();
    554 +  // Change theme using ThemeManager
    555 +  async function changeTheme(themeName) {
    556 +    await themeManager.loadTheme(themeName);
    557 +    // ThemeManager listener (above) will handle the re-render automatically
    558 +  }
626 559  
627     -  function generateHTML() {
628     -    const html = `<!DOCTYPE html>
    560 +  // Initialize color inputs
    561 +  function initColorInputs() {
    562 +    document.querySelectorAll('.color-control input[type="color"]').forEach(input => {
    563 +      const varName = input.dataset.var;
    564 +      const textInput = document.getElementById(input.id + '-text');
    565 +      const currentValue = getComputedStyle(document.documentElement)
    566 +        .getPropertyValue(varName)
    567 +        .trim();
    568 +
    569 +      input.value = currentValue;
    570 +      textInput.value = currentValue;
    571 +
    572 +      input.addEventListener('input', e => {
    573 +        const color = e.target.value;
    574 +        document.documentElement.style.setProperty(varName, color);
    575 +        textInput.value = color;
    576 +      });
    577 +    });
    578 +  }
    579 +
    580 +  // Export to HTML
    581 +  function exportHTML() {
    582 +    const currentTheme = themeSelector.value;
    583 +    let themeCSS = '';
    584 +
    585 +    if (currentTheme === 'custom') {
    586 +      const customTheme = storageManager.getJSON('customTheme');
    587 +      if (customTheme) {
    588 +        const theme = customTheme;
    589 +        themeCSS = ':root {\n';
    590 +        Object.entries(theme).forEach(([property, value]) => {
    591 +          themeCSS += `    ${property}: ${value};\n`;
    592 +        });
    593 +        themeCSS += '}';
    594 +      }
    595 +    } else {
    596 +      // Fetch theme CSS
    597 +      fetch(`themes/${currentTheme}.css`)
    598 +        .then(response => response.text())
    599 +        .then(css => {
    600 +          themeCSS = css;
    601 +          generateHTML();
    602 +        })
    603 +        .catch(err => {
    604 +          console.error('Error loading theme:', err);
    605 +          generateHTML();
    606 +        });
    607 +      return;
    608 +    }
    609 +
    610 +    generateHTML();
    611 +
    612 +    function generateHTML() {
    613 +      const html = `<!DOCTYPE html>
629 614  <html>
630 615  <head>
631 616      <meta charset="UTF-8">
@@ -679,720 +664,720 @@ function exportHTML() {
679 664  </body>
680 665  </html>`;
681 666  
682     -    const blob = new Blob([html], { type: 'text/html' });
683     -    const url = URL.createObjectURL(blob);
684     -    const a = document.createElement('a');
685     -    a.href = url;
686     -    a.download = 'markdown-export.html';
687     -    a.click();
688     -    URL.revokeObjectURL(url);
    667 +      const blob = new Blob([html], { type: 'text/html' });
    668 +      const url = URL.createObjectURL(blob);
    669 +      const a = document.createElement('a');
    670 +      a.href = url;
    671 +      a.download = 'markdown-export.html';
    672 +      a.click();
    673 +      URL.revokeObjectURL(url);
    674 +    }
689 675    }
690     -}
691 676  
692     -// Event Listeners
693     -const debouncedRender = debounce(renderMarkdown, 300);
694     -editor.addEventListener('input', debouncedRender);
    677 +  // Event Listeners
    678 +  const debouncedRender = debounce(renderMarkdown, 300);
    679 +  editor.addEventListener('input', debouncedRender);
695 680  
696     -themeSelector.addEventListener('change', async e => {
697     -  await changeTheme(e.target.value);
698     -});
699     -
700     -customizeBtn.addEventListener('click', () => {
701     -  modal.classList.add('active');
702     -  initColorInputs();
703     -});
704     -
705     -closeModal.addEventListener('click', () => {
706     -  modal.classList.remove('active');
707     -});
708     -
709     -modal.addEventListener('click', e => {
710     -  if (e.target === modal) {
711     -    modal.classList.remove('active');
712     -  }
713     -});
714     -
715     -resetBtn.addEventListener('click', async () => {
716     -  const currentTheme = themeSelector.value === 'custom' ? 'default-light' : themeSelector.value;
717     -  await changeTheme(currentTheme);
718     -  initColorInputs();
719     -});
720     -
721     -saveThemeBtn.addEventListener('click', async () => {
722     -  const customTheme = {};
723     -  document.querySelectorAll('.color-control input[type="color"]').forEach(input => {
724     -    const varName = input.dataset.var;
725     -    customTheme[varName] = input.value;
    681 +  themeSelector.addEventListener('change', async e => {
    682 +    await changeTheme(e.target.value);
726 683    });
727 684  
728     -  // Save and load custom theme using ThemeManager
729     -  themeManager.saveCustomTheme(customTheme);
730     -  await themeManager.loadTheme('custom');
731     -  themeSelector.value = 'custom';
    685 +  customizeBtn.addEventListener('click', () => {
    686 +    modal.classList.add('active');
    687 +    initColorInputs();
    688 +  });
732 689  
733     -  alert('Custom theme saved and applied!');
734     -  modal.classList.remove('active');
735     -});
    690 +  closeModal.addEventListener('click', () => {
    691 +    modal.classList.remove('active');
    692 +  });
736 693  
737     -// PDF Modal and Controls
738     -const pdfModal = document.getElementById('pdf-modal');
739     -const closePdfModal = document.getElementById('close-pdf-modal');
740     -const pdfPreviewFrame = document.getElementById('pdf-preview-frame');
741     -const pdfPageSize = document.getElementById('pdf-page-size');
742     -const pdfOrientation = document.getElementById('pdf-orientation');
743     -const pdfMarginTop = document.getElementById('pdf-margin-top');
744     -const pdfMarginRight = document.getElementById('pdf-margin-right');
745     -const pdfMarginBottom = document.getElementById('pdf-margin-bottom');
746     -const pdfMarginLeft = document.getElementById('pdf-margin-left');
747     -const pdfFontDecrease = document.getElementById('pdf-font-decrease');
748     -const pdfFontIncrease = document.getElementById('pdf-font-increase');
749     -const pdfFontSizeDisplay = document.getElementById('pdf-font-size-display');
750     -const pdfPreviewBtn = document.getElementById('pdf-preview-btn');
751     -const pdfDownloadBtn = document.getElementById('pdf-download-btn');
    694 +  modal.addEventListener('click', e => {
    695 +    if (e.target === modal) {
    696 +      modal.classList.remove('active');
    697 +    }
    698 +  });
752 699  
753     -let currentFontSize = 12;
    700 +  resetBtn.addEventListener('click', async () => {
    701 +    const currentTheme = themeSelector.value === 'custom' ? 'default-light' : themeSelector.value;
    702 +    await changeTheme(currentTheme);
    703 +    initColorInputs();
    704 +  });
754 705  
755     -// Open PDF modal
756     -function openPDFModal() {
757     -  if (!pdfService.isReady()) {
758     -    alert('PDF library is still loading. Please try again in a moment.');
759     -    return;
    706 +  saveThemeBtn.addEventListener('click', async () => {
    707 +    const customTheme = {};
    708 +    document.querySelectorAll('.color-control input[type="color"]').forEach(input => {
    709 +      const varName = input.dataset.var;
    710 +      customTheme[varName] = input.value;
    711 +    });
    712 +
    713 +    // Save and load custom theme using ThemeManager
    714 +    themeManager.saveCustomTheme(customTheme);
    715 +    await themeManager.loadTheme('custom');
    716 +    themeSelector.value = 'custom';
    717 +
    718 +    alert('Custom theme saved and applied!');
    719 +    modal.classList.remove('active');
    720 +  });
    721 +
    722 +  // PDF Modal and Controls
    723 +  const pdfModal = document.getElementById('pdf-modal');
    724 +  const closePdfModal = document.getElementById('close-pdf-modal');
    725 +  const pdfPreviewFrame = document.getElementById('pdf-preview-frame');
    726 +  const pdfPageSize = document.getElementById('pdf-page-size');
    727 +  const pdfOrientation = document.getElementById('pdf-orientation');
    728 +  const pdfMarginTop = document.getElementById('pdf-margin-top');
    729 +  const pdfMarginRight = document.getElementById('pdf-margin-right');
    730 +  const pdfMarginBottom = document.getElementById('pdf-margin-bottom');
    731 +  const pdfMarginLeft = document.getElementById('pdf-margin-left');
    732 +  const pdfFontDecrease = document.getElementById('pdf-font-decrease');
    733 +  const pdfFontIncrease = document.getElementById('pdf-font-increase');
    734 +  const pdfFontSizeDisplay = document.getElementById('pdf-font-size-display');
    735 +  const pdfPreviewBtn = document.getElementById('pdf-preview-btn');
    736 +  const pdfDownloadBtn = document.getElementById('pdf-download-btn');
    737 +
    738 +  let currentFontSize = 12;
    739 +
    740 +  // Open PDF modal
    741 +  function openPDFModal() {
    742 +    if (!pdfService.isReady()) {
    743 +      alert('PDF library is still loading. Please try again in a moment.');
    744 +      return;
    745 +    }
    746 +    pdfModal.classList.add('active');
    747 +    updatePDFPreview();
760 748    }
761     -  pdfModal.classList.add('active');
762     -  updatePDFPreview();
763     -}
764 749  
765     -// Close PDF modal
766     -closePdfModal.addEventListener('click', () => {
767     -  pdfModal.classList.remove('active');
768     -  // Clean up iframe
769     -  pdfPreviewFrame.src = '';
770     -});
771     -
772     -pdfModal.addEventListener('click', e => {
773     -  if (e.target === pdfModal) {
    750 +  // Close PDF modal
    751 +  closePdfModal.addEventListener('click', () => {
774 752      pdfModal.classList.remove('active');
    753 +    // Clean up iframe
775 754      pdfPreviewFrame.src = '';
    755 +  });
    756 +
    757 +  pdfModal.addEventListener('click', e => {
    758 +    if (e.target === pdfModal) {
    759 +      pdfModal.classList.remove('active');
    760 +      pdfPreviewFrame.src = '';
    761 +    }
    762 +  });
    763 +
    764 +  // Get current PDF configuration from UI
    765 +  function getPDFConfig() {
    766 +    return {
    767 +      pageSize: pdfPageSize.value,
    768 +      orientation: pdfOrientation.value,
    769 +      margins: [
    770 +        parseFloat(pdfMarginTop.value),
    771 +        parseFloat(pdfMarginRight.value),
    772 +        parseFloat(pdfMarginBottom.value),
    773 +        parseFloat(pdfMarginLeft.value),
    774 +      ],
    775 +      fontSize: currentFontSize,
    776 +    };
776 777    }
777     -});
778 778  
779     -// Get current PDF configuration from UI
780     -function getPDFConfig() {
781     -  return {
782     -    pageSize: pdfPageSize.value,
783     -    orientation: pdfOrientation.value,
784     -    margins: [
785     -      parseFloat(pdfMarginTop.value),
786     -      parseFloat(pdfMarginRight.value),
787     -      parseFloat(pdfMarginBottom.value),
788     -      parseFloat(pdfMarginLeft.value),
789     -    ],
790     -    fontSize: currentFontSize,
791     -  };
792     -}
    779 +  // Update PDF preview
    780 +  async function updatePDFPreview() {
    781 +    try {
    782 +      pdfPreviewBtn.textContent = 'â³ Generating Preview...';
    783 +      pdfPreviewBtn.disabled = true;
793 784  
794     -// Update PDF preview
795     -async function updatePDFPreview() {
796     -  try {
797     -    pdfPreviewBtn.textContent = 'â³ Generating Preview...';
798     -    pdfPreviewBtn.disabled = true;
    785 +      const config = getPDFConfig();
    786 +      const previewUrl = await pdfService.previewPDF(preview, config);
    787 +      pdfPreviewFrame.src = previewUrl;
799 788  
800     -    const config = getPDFConfig();
801     -    const previewUrl = await pdfService.previewPDF(preview, config);
802     -    pdfPreviewFrame.src = previewUrl;
803     -
804     -    pdfPreviewBtn.textContent = 'ðŸ‘ï¸ Update Preview';
805     -    pdfPreviewBtn.disabled = false;
806     -  } catch (error) {
807     -    console.error('PDF preview error:', error);
808     -    alert('Error generating preview: ' + error.message);
809     -    pdfPreviewBtn.textContent = 'ðŸ‘ï¸ Update Preview';
810     -    pdfPreviewBtn.disabled = false;
    789 +      pdfPreviewBtn.textContent = 'ðŸ‘ï¸ Update Preview';
    790 +      pdfPreviewBtn.disabled = false;
    791 +    } catch (error) {
    792 +      console.error('PDF preview error:', error);
    793 +      alert('Error generating preview: ' + error.message);
    794 +      pdfPreviewBtn.textContent = 'ðŸ‘ï¸ Update Preview';
    795 +      pdfPreviewBtn.disabled = false;
    796 +    }
811 797    }
812     -}
813 798  
814     -// Download PDF
815     -async function downloadPDF() {
816     -  try {
817     -    pdfDownloadBtn.textContent = 'â³ Downloading...';
818     -    pdfDownloadBtn.disabled = true;
    799 +  // Download PDF
    800 +  async function downloadPDF() {
    801 +    try {
    802 +      pdfDownloadBtn.textContent = 'â³ Downloading...';
    803 +      pdfDownloadBtn.disabled = true;
819 804  
820     -    const success = pdfService.downloadPDF();
821     -    if (success) {
822     -      setTimeout(() => {
823     -        pdfModal.classList.remove('active');
824     -        pdfPreviewFrame.src = '';
825     -      }, 500);
    805 +      const success = pdfService.downloadPDF();
    806 +      if (success) {
    807 +        setTimeout(() => {
    808 +          pdfModal.classList.remove('active');
    809 +          pdfPreviewFrame.src = '';
    810 +        }, 500);
    811 +      }
    812 +
    813 +      pdfDownloadBtn.textContent = 'ðŸ’¾ Download PDF';
    814 +      pdfDownloadBtn.disabled = false;
    815 +    } catch (error) {
    816 +      console.error('PDF download error:', error);
    817 +      alert('Error downloading PDF: ' + error.message);
    818 +      pdfDownloadBtn.textContent = 'ðŸ’¾ Download PDF';
    819 +      pdfDownloadBtn.disabled = false;
    820 +    }
    821 +  }
    822 +
    823 +  // Font size controls with auto-update
    824 +  pdfFontDecrease.addEventListener('click', () => {
    825 +    if (currentFontSize > 8) {
    826 +      currentFontSize -= 1;
    827 +      pdfFontSizeDisplay.textContent = `${currentFontSize}pt`;
    828 +      updatePDFPreview();
    829 +    }
    830 +  });
    831 +
    832 +  pdfFontIncrease.addEventListener('click', () => {
    833 +    if (currentFontSize < 24) {
    834 +      currentFontSize += 1;
    835 +      pdfFontSizeDisplay.textContent = `${currentFontSize}pt`;
    836 +      updatePDFPreview();
    837 +    }
    838 +  });
    839 +
    840 +  // Auto-update preview when settings change
    841 +  pdfPageSize.addEventListener('change', updatePDFPreview);
    842 +  pdfOrientation.addEventListener('change', updatePDFPreview);
    843 +  pdfMarginTop.addEventListener('input', updatePDFPreview);
    844 +  pdfMarginRight.addEventListener('input', updatePDFPreview);
    845 +  pdfMarginBottom.addEventListener('input', updatePDFPreview);
    846 +  pdfMarginLeft.addEventListener('input', updatePDFPreview);
    847 +
    848 +  // PDF Event Listeners
    849 +  pdfPreviewBtn.addEventListener('click', updatePDFPreview);
    850 +  pdfDownloadBtn.addEventListener('click', downloadPDF);
    851 +
    852 +  // Event listeners for export buttons
    853 +  exportHtmlBtn.addEventListener('click', exportHTML);
    854 +  exportPdfBtn.addEventListener('click', () => {
    855 +    console.log('Export PDF button clicked');
    856 +    openPDFModal();
    857 +  });
    858 +
    859 +  // Debug: Verify elements are found
    860 +  console.log('Export PDF Button:', exportPdfBtn);
    861 +  console.log('PDF Modal:', pdfModal);
    862 +  console.log('PDF Service Ready:', pdfService.isReady());
    863 +
    864 +  // View mode switching
    865 +  function setViewMode(mode) {
    866 +    // Remove active class from all buttons
    867 +    editorOnlyBtn.classList.remove('active');
    868 +    splitViewBtn.classList.remove('active');
    869 +    previewOnlyBtn.classList.remove('active');
    870 +
    871 +    // Apply view mode
    872 +    switch (mode) {
    873 +      case 'editor-only':
    874 +        editorOnlyBtn.classList.add('active');
    875 +        editorContainer.style.display = 'flex';
    876 +        previewContainer.style.display = 'none';
    877 +        break;
    878 +      case 'split-view':
    879 +        splitViewBtn.classList.add('active');
    880 +        editorContainer.style.display = 'flex';
    881 +        previewContainer.style.display = 'flex';
    882 +        break;
    883 +      case 'preview-only':
    884 +        previewOnlyBtn.classList.add('active');
    885 +        editorContainer.style.display = 'none';
    886 +        previewContainer.style.display = 'flex';
    887 +        break;
826 888      }
827 889  
828     -    pdfDownloadBtn.textContent = 'ðŸ’¾ Download PDF';
829     -    pdfDownloadBtn.disabled = false;
830     -  } catch (error) {
831     -    console.error('PDF download error:', error);
832     -    alert('Error downloading PDF: ' + error.message);
833     -    pdfDownloadBtn.textContent = 'ðŸ’¾ Download PDF';
834     -    pdfDownloadBtn.disabled = false;
835     -  }
836     -}
837     -
838     -// Font size controls with auto-update
839     -pdfFontDecrease.addEventListener('click', () => {
840     -  if (currentFontSize > 8) {
841     -    currentFontSize -= 1;
842     -    pdfFontSizeDisplay.textContent = `${currentFontSize}pt`;
843     -    updatePDFPreview();
844     -  }
845     -});
846     -
847     -pdfFontIncrease.addEventListener('click', () => {
848     -  if (currentFontSize < 24) {
849     -    currentFontSize += 1;
850     -    pdfFontSizeDisplay.textContent = `${currentFontSize}pt`;
851     -    updatePDFPreview();
852     -  }
853     -});
854     -
855     -// Auto-update preview when settings change
856     -pdfPageSize.addEventListener('change', updatePDFPreview);
857     -pdfOrientation.addEventListener('change', updatePDFPreview);
858     -pdfMarginTop.addEventListener('input', updatePDFPreview);
859     -pdfMarginRight.addEventListener('input', updatePDFPreview);
860     -pdfMarginBottom.addEventListener('input', updatePDFPreview);
861     -pdfMarginLeft.addEventListener('input', updatePDFPreview);
862     -
863     -// PDF Event Listeners
864     -pdfPreviewBtn.addEventListener('click', updatePDFPreview);
865     -pdfDownloadBtn.addEventListener('click', downloadPDF);
866     -
867     -// Event listeners for export buttons
868     -exportHtmlBtn.addEventListener('click', exportHTML);
869     -exportPdfBtn.addEventListener('click', () => {
870     -  console.log('Export PDF button clicked');
871     -  openPDFModal();
872     -});
873     -
874     -// Debug: Verify elements are found
875     -console.log('Export PDF Button:', exportPdfBtn);
876     -console.log('PDF Modal:', pdfModal);
877     -console.log('PDF Service Ready:', pdfService.isReady());
878     -
879     -// View mode switching
880     -function setViewMode(mode) {
881     -  // Remove active class from all buttons
882     -  editorOnlyBtn.classList.remove('active');
883     -  splitViewBtn.classList.remove('active');
884     -  previewOnlyBtn.classList.remove('active');
885     -
886     -  // Apply view mode
887     -  switch (mode) {
888     -    case 'editor-only':
889     -      editorOnlyBtn.classList.add('active');
890     -      editorContainer.style.display = 'flex';
891     -      previewContainer.style.display = 'none';
892     -      break;
893     -    case 'split-view':
894     -      splitViewBtn.classList.add('active');
895     -      editorContainer.style.display = 'flex';
896     -      previewContainer.style.display = 'flex';
897     -      break;
898     -    case 'preview-only':
899     -      previewOnlyBtn.classList.add('active');
900     -      editorContainer.style.display = 'none';
901     -      previewContainer.style.display = 'flex';
902     -      break;
    890 +    // Save view mode preference
    891 +    storageManager.set('viewMode', mode);
903 892    }
904 893  
905     -  // Save view mode preference
906     -  storageManager.set('viewMode', mode);
907     -}
    894 +  // ==================== SYNC SCROLL FUNCTIONALITY ====================
908 895  
909     -// ==================== SYNC SCROLL FUNCTIONALITY ====================
910     -
911     -// Sync scroll state (using var to avoid formatter issues)
912     -var syncScrollEnabled = storageManager.get('syncScrollEnabled') === 'true';
913     -var syncScrolling = false;
914     -
915     -// Load saved state and update button
916     -if (syncScrollEnabled) {
917     -  syncScrollBtn.classList.add('active');
918     -}
919     -
920     -// Show sync scroll button only in split view
921     -function updateSyncScrollVisibility() {
922     -  const currentView = storageManager.get('viewMode') || 'split-view';
923     -  if (currentView === 'split-view') {
924     -    syncScrollBtn.style.display = 'inline-block';
925     -  } else {
926     -    syncScrollBtn.style.display = 'none';
927     -  }
928     -}
929     -
930     -// Sync scroll toggle
931     -syncScrollBtn.addEventListener('click', () => {
932     -  syncScrollEnabled = !syncScrollEnabled;
933     -  storageManager.set('syncScrollEnabled', syncScrollEnabled.toString());
    896 +  // Sync scroll state (using var to avoid formatter issues)
    897 +  var syncScrollEnabled = storageManager.get('syncScrollEnabled') === 'true';
    898 +  var syncScrolling = false;
934 899  
    900 +  // Load saved state and update button
935 901    if (syncScrollEnabled) {
936 902      syncScrollBtn.classList.add('active');
937     -    console.log('âœ… Sync scroll enabled');
938     -  } else {
939     -    syncScrollBtn.classList.remove('active');
940     -    console.log('âŒ Sync scroll disabled');
941 903    }
942     -});
943 904  
944     -// Editor scroll handler with smooth sync
945     -editor.addEventListener('scroll', () => {
946     -  if (!syncScrollEnabled || syncScrolling) return;
947     -
948     -  syncScrolling = true;
949     -
950     -  requestAnimationFrame(() => {
951     -    const editorHeight = editor.scrollHeight - editor.clientHeight;
952     -    const previewHeight = previewContainer.scrollHeight - previewContainer.clientHeight;
953     -
954     -    // Handle edge cases for perfect alignment
955     -    if (editor.scrollTop <= 0) {
956     -      // At top
957     -      previewContainer.scrollTop = 0;
958     -    } else if (editor.scrollTop >= editorHeight) {
959     -      // At bottom
960     -      previewContainer.scrollTop = previewHeight;
    905 +  // Show sync scroll button only in split view
    906 +  function updateSyncScrollVisibility() {
    907 +    const currentView = storageManager.get('viewMode') || 'split-view';
    908 +    if (currentView === 'split-view') {
    909 +      syncScrollBtn.style.display = 'inline-block';
961 910      } else {
962     -      // Middle - proportional scroll
963     -      const scrollPercent = editor.scrollTop / editorHeight;
964     -      previewContainer.scrollTop = scrollPercent * previewHeight;
    911 +      syncScrollBtn.style.display = 'none';
965 912      }
    913 +  }
966 914  
967     -    setTimeout(() => {
968     -      syncScrolling = false;
969     -    }, 10); // Reduced from 50ms for more responsive feel
970     -  });
971     -});
    915 +  // Sync scroll toggle
    916 +  syncScrollBtn.addEventListener('click', () => {
    917 +    syncScrollEnabled = !syncScrollEnabled;
    918 +    storageManager.set('syncScrollEnabled', syncScrollEnabled.toString());
972 919  
973     -// Preview container scroll handler with smooth sync
974     -previewContainer.addEventListener('scroll', () => {
975     -  if (!syncScrollEnabled || syncScrolling) return;
976     -
977     -  syncScrolling = true;
978     -
979     -  requestAnimationFrame(() => {
980     -    const editorHeight = editor.scrollHeight - editor.clientHeight;
981     -    const previewHeight = previewContainer.scrollHeight - previewContainer.clientHeight;
982     -
983     -    // Handle edge cases for perfect alignment
984     -    if (previewContainer.scrollTop <= 0) {
985     -      // At top
986     -      editor.scrollTop = 0;
987     -    } else if (previewContainer.scrollTop >= previewHeight) {
988     -      // At bottom
989     -      editor.scrollTop = editorHeight;
    920 +    if (syncScrollEnabled) {
    921 +      syncScrollBtn.classList.add('active');
    922 +      console.log('âœ… Sync scroll enabled');
990 923      } else {
991     -      // Middle - proportional scroll
992     -      const scrollPercent = previewContainer.scrollTop / previewHeight;
993     -      editor.scrollTop = scrollPercent * editorHeight;
    924 +      syncScrollBtn.classList.remove('active');
    925 +      console.log('âŒ Sync scroll disabled');
994 926      }
995     -
996     -    setTimeout(() => {
997     -      syncScrolling = false;
998     -    }, 10); // Reduced from 50ms for more responsive feel
999 927    });
1000     -});
1001 928  
1002     -// View mode button event listeners with sync button update
1003     -editorOnlyBtn.addEventListener('click', () => {
1004     -  setViewMode('editor-only');
1005     -  updateSyncScrollVisibility();
1006     -});
1007     -splitViewBtn.addEventListener('click', () => {
1008     -  setViewMode('split-view');
1009     -  updateSyncScrollVisibility();
1010     -});
1011     -previewOnlyBtn.addEventListener('click', () => {
1012     -  setViewMode('preview-only');
1013     -  updateSyncScrollVisibility();
1014     -});
    929 +  // Editor scroll handler with smooth sync
    930 +  editor.addEventListener('scroll', () => {
    931 +    if (!syncScrollEnabled || syncScrolling) return;
1015 932  
1016     -// Initialize visibility
1017     -updateSyncScrollVisibility();
    933 +    syncScrolling = true;
1018 934  
1019     -// Load saved theme FIRST, then initialize Mermaid with correct colors
1020     -const savedTheme = storageManager.get('selectedTheme');
1021     -if (savedTheme) {
1022     -  // Load theme first, then sync dropdown and reinit Mermaid
1023     -  themeManager
1024     -    .loadTheme(savedTheme)
1025     -    .then(() => {
1026     -      // Theme loaded successfully - sync dropdown
1027     -      themeSelector.value = savedTheme;
1028     -      console.log(`âœ… Theme restored: ${savedTheme}`);
    935 +    requestAnimationFrame(() => {
    936 +      const editorHeight = editor.scrollHeight - editor.clientHeight;
    937 +      const previewHeight = previewContainer.scrollHeight - previewContainer.clientHeight;
1029 938  
1030     -      // NOW initialize Mermaid with correct theme colors
1031     -      mermaidService.initialize();
    939 +      // Handle edge cases for perfect alignment
    940 +      if (editor.scrollTop <= 0) {
    941 +        // At top
    942 +        previewContainer.scrollTop = 0;
    943 +      } else if (editor.scrollTop >= editorHeight) {
    944 +        // At bottom
    945 +        previewContainer.scrollTop = previewHeight;
    946 +      } else {
    947 +        // Middle - proportional scroll
    948 +        const scrollPercent = editor.scrollTop / editorHeight;
    949 +        previewContainer.scrollTop = scrollPercent * previewHeight;
    950 +      }
1032 951  
1033     -      // Re-render to apply theme
1034     -      renderMarkdown();
1035     -    })
1036     -    .catch(err => {
1037     -      console.error('Failed to load saved theme:', err);
1038     -      // Fallback to default-light on error
1039     -      themeManager.loadTheme('default-light').then(() => {
1040     -        themeSelector.value = 'default-light';
1041     -        mermaidService.initialize();
1042     -        renderMarkdown();
1043     -      });
    952 +      setTimeout(() => {
    953 +        syncScrolling = false;
    954 +      }, 10); // Reduced from 50ms for more responsive feel
1044 955      });
1045     -} else {
1046     -  // No saved theme - initialize with default-light
1047     -  mermaidService.initialize();
1048     -  renderMarkdown();
1049     -}
    956 +  });
1050 957  
1051     -// Zoom functionality
1052     -function setZoom(zoomLevel) {
1053     -  // Constrain zoom level between 50% and 200%
1054     -  currentZoom = Math.max(50, Math.min(200, zoomLevel));
    958 +  // Preview container scroll handler with smooth sync
    959 +  previewContainer.addEventListener('scroll', () => {
    960 +    if (!syncScrollEnabled || syncScrolling) return;
1055 961  
1056     -  // Apply zoom using CSS transform with proper container sizing
1057     -  preview.style.transform = `scale(${currentZoom / 100})`;
1058     -  preview.style.transformOrigin = 'top left';
1059     -  preview.style.width = `${10000 / currentZoom}%`;
1060     -  preview.style.height = `${10000 / currentZoom}%`;
    962 +    syncScrolling = true;
1061 963  
1062     -  // Ensure scrollbar remains visible and functional
1063     -  const previewContainer = preview.parentElement;
1064     -  if (previewContainer) {
1065     -    previewContainer.style.overflow = 'auto';
    964 +    requestAnimationFrame(() => {
    965 +      const editorHeight = editor.scrollHeight - editor.clientHeight;
    966 +      const previewHeight = previewContainer.scrollHeight - previewContainer.clientHeight;
    967 +
    968 +      // Handle edge cases for perfect alignment
    969 +      if (previewContainer.scrollTop <= 0) {
    970 +        // At top
    971 +        editor.scrollTop = 0;
    972 +      } else if (previewContainer.scrollTop >= previewHeight) {
    973 +        // At bottom
    974 +        editor.scrollTop = editorHeight;
    975 +      } else {
    976 +        // Middle - proportional scroll
    977 +        const scrollPercent = previewContainer.scrollTop / previewHeight;
    978 +        editor.scrollTop = scrollPercent * editorHeight;
    979 +      }
    980 +
    981 +      setTimeout(() => {
    982 +        syncScrolling = false;
    983 +      }, 10); // Reduced from 50ms for more responsive feel
    984 +    });
    985 +  });
    986 +
    987 +  // View mode button event listeners with sync button update
    988 +  editorOnlyBtn.addEventListener('click', () => {
    989 +    setViewMode('editor-only');
    990 +    updateSyncScrollVisibility();
    991 +  });
    992 +  splitViewBtn.addEventListener('click', () => {
    993 +    setViewMode('split-view');
    994 +    updateSyncScrollVisibility();
    995 +  });
    996 +  previewOnlyBtn.addEventListener('click', () => {
    997 +    setViewMode('preview-only');
    998 +    updateSyncScrollVisibility();
    999 +  });
    1000 +
    1001 +  // Initialize visibility
    1002 +  updateSyncScrollVisibility();
    1003 +
    1004 +  // Load saved theme FIRST, then initialize Mermaid with correct colors
    1005 +  const savedTheme = storageManager.get('selectedTheme');
    1006 +  if (savedTheme) {
    1007 +    // Load theme first, then sync dropdown and reinit Mermaid
    1008 +    themeManager
    1009 +      .loadTheme(savedTheme)
    1010 +      .then(() => {
    1011 +        // Theme loaded successfully - sync dropdown
    1012 +        themeSelector.value = savedTheme;
    1013 +        console.log(`âœ… Theme restored: ${savedTheme}`);
    1014 +
    1015 +        // NOW initialize Mermaid with correct theme colors
    1016 +        mermaidService.initialize();
    1017 +
    1018 +        // Re-render to apply theme
    1019 +        renderMarkdown();
    1020 +      })
    1021 +      .catch(err => {
    1022 +        console.error('Failed to load saved theme:', err);
    1023 +        // Fallback to default-light on error
    1024 +        themeManager.loadTheme('default-light').then(() => {
    1025 +          themeSelector.value = 'default-light';
    1026 +          mermaidService.initialize();
    1027 +          renderMarkdown();
    1028 +        });
    1029 +      });
    1030 +  } else {
    1031 +    // No saved theme - initialize with default-light
    1032 +    mermaidService.initialize();
    1033 +    renderMarkdown();
1066 1034    }
1067 1035  
1068     -  // Update display
1069     -  zoomLevelDisplay.textContent = `${currentZoom}%`;
    1036 +  // Zoom functionality
    1037 +  function setZoom(zoomLevel) {
    1038 +    // Constrain zoom level between 50% and 200%
    1039 +    currentZoom = Math.max(50, Math.min(200, zoomLevel));
1070 1040  
1071     -  // Save to localStorage
1072     -  storageManager.set('previewZoom', currentZoom.toString());
1073     -}
    1041 +    // Apply zoom using CSS transform with proper container sizing
    1042 +    preview.style.transform = `scale(${currentZoom / 100})`;
    1043 +    preview.style.transformOrigin = 'top left';
    1044 +    preview.style.width = `${10000 / currentZoom}%`;
    1045 +    preview.style.height = `${10000 / currentZoom}%`;
1074 1046  
1075     -function zoomIn() {
1076     -  setZoom(currentZoom + 10);
1077     -}
    1047 +    // Ensure scrollbar remains visible and functional
    1048 +    const previewContainer = preview.parentElement;
    1049 +    if (previewContainer) {
    1050 +      previewContainer.style.overflow = 'auto';
    1051 +    }
1078 1052  
1079     -function zoomOut() {
1080     -  setZoom(currentZoom - 10);
1081     -}
    1053 +    // Update display
    1054 +    zoomLevelDisplay.textContent = `${currentZoom}%`;
1082 1055  
1083     -function resetZoom() {
1084     -  setZoom(100);
1085     -}
    1056 +    // Save to localStorage
    1057 +    storageManager.set('previewZoom', currentZoom.toString());
    1058 +  }
1086 1059  
1087     -// Zoom event listeners
1088     -zoomInBtn.addEventListener('click', zoomIn);
1089     -zoomOutBtn.addEventListener('click', zoomOut);
1090     -zoomResetBtn.addEventListener('click', resetZoom);
    1060 +  function zoomIn() {
    1061 +    setZoom(currentZoom + 10);
    1062 +  }
1091 1063  
1092     -// Keyboard shortcuts for zoom (Ctrl/Cmd + Plus/Minus/0)
1093     -preview.addEventListener('wheel', e => {
1094     -  if (e.ctrlKey || e.metaKey) {
    1064 +  function zoomOut() {
    1065 +    setZoom(currentZoom - 10);
    1066 +  }
    1067 +
    1068 +  function resetZoom() {
    1069 +    setZoom(100);
    1070 +  }
    1071 +
    1072 +  // Zoom event listeners
    1073 +  zoomInBtn.addEventListener('click', zoomIn);
    1074 +  zoomOutBtn.addEventListener('click', zoomOut);
    1075 +  zoomResetBtn.addEventListener('click', resetZoom);
    1076 +
    1077 +  // Keyboard shortcuts for zoom (Ctrl/Cmd + Plus/Minus/0)
    1078 +  preview.addEventListener('wheel', e => {
    1079 +    if (e.ctrlKey || e.metaKey) {
    1080 +      e.preventDefault();
    1081 +      if (e.deltaY < 0) {
    1082 +        zoomIn();
    1083 +      } else {
    1084 +        zoomOut();
    1085 +      }
    1086 +    }
    1087 +  });
    1088 +
    1089 +  document.addEventListener('keydown', e => {
    1090 +    if ((e.ctrlKey || e.metaKey) && e.target.tagName !== 'TEXTAREA') {
    1091 +      if (e.key === '=' || e.key === '+') {
    1092 +        e.preventDefault();
    1093 +        zoomIn();
    1094 +      } else if (e.key === '-') {
    1095 +        e.preventDefault();
    1096 +        zoomOut();
    1097 +      } else if (e.key === '0') {
    1098 +        e.preventDefault();
    1099 +        resetZoom();
    1100 +      }
    1101 +    }
    1102 +  });
    1103 +
    1104 +  // Load saved zoom level
    1105 +  const savedZoom = storageManager.get('previewZoom');
    1106 +  if (savedZoom) {
    1107 +    currentZoom = parseInt(savedZoom, 10);
    1108 +    setZoom(currentZoom);
    1109 +  }
    1110 +
    1111 +  // Load saved view mode
    1112 +  const savedViewMode = storageManager.get('viewMode') || 'split-view';
    1113 +  setViewMode(savedViewMode);
    1114 +
    1115 +  // ==================== FOLDER BROWSER FUNCTIONALITY ====================
    1116 +
    1117 +  // Folder browser DOM elements
    1118 +  const fileBrowser = document.getElementById('file-browser');
    1119 +  const openFolderBtn = document.getElementById('open-folder-btn');
    1120 +  const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
    1121 +  const closeBrowserBtn = document.getElementById('close-browser-btn');
    1122 +  const floatingShowBtn = document.getElementById('floating-show-btn');
    1123 +  const resizeHandle = document.getElementById('resize-handle');
    1124 +  const fileTree = document.getElementById('file-tree');
    1125 +  const currentFolderNameEl = document.getElementById('current-folder-name');
    1126 +  const fileCountEl = document.getElementById('file-count');
    1127 +
    1128 +  // Folder browser state (using let to allow reassignment)
    1129 +  let folderFiles = [];
    1130 +  let activeFileHandle = null;
    1131 +  let isResizing = false;
    1132 +  let sidebarWidth = 280; // Default width
    1133 +  const minWidth = 100; // Allow squeezing to very narrow
    1134 +  const maxWidth = 600;
    1135 +  const collapseThreshold = 80; // Auto-collapse at very left edge only
    1136 +
    1137 +  // Load saved sidebar width
    1138 +  const savedWidth = storageManager.get('sidebarWidth');
    1139 +  if (savedWidth) {
    1140 +    sidebarWidth = parseInt(savedWidth, 10);
    1141 +  }
    1142 +
    1143 +  // Resize functionality
    1144 +  resizeHandle.addEventListener('mousedown', e => {
    1145 +    isResizing = true;
    1146 +    fileBrowser.classList.add('resizing');
    1147 +    resizeHandle.classList.add('dragging');
    1148 +    document.body.style.cursor = 'col-resize';
    1149 +    document.body.style.userSelect = 'none';
1095 1150      e.preventDefault();
1096     -    if (e.deltaY < 0) {
1097     -      zoomIn();
1098     -    } else {
1099     -      zoomOut();
    1151 +  });
    1152 +
    1153 +  document.addEventListener('mousemove', e => {
    1154 +    if (!isResizing) return;
    1155 +
    1156 +    const newWidth = e.clientX;
    1157 +
    1158 +    // Check if dragged to leftmost (auto-collapse)
    1159 +    if (newWidth < collapseThreshold) {
    1160 +      // Auto-collapse with smooth animation
    1161 +      fileBrowser.classList.remove('resizing');
    1162 +      fileBrowser.style.display = 'none';
    1163 +      floatingShowBtn.style.display = 'block';
    1164 +      isResizing = false;
    1165 +      resizeHandle.classList.remove('dragging');
    1166 +      document.body.style.cursor = '';
    1167 +      document.body.style.userSelect = '';
    1168 +      return;
1100 1169      }
1101     -  }
1102     -});
1103 1170  
1104     -document.addEventListener('keydown', e => {
1105     -  if ((e.ctrlKey || e.metaKey) && e.target.tagName !== 'TEXTAREA') {
1106     -    if (e.key === '=' || e.key === '+') {
1107     -      e.preventDefault();
1108     -      zoomIn();
1109     -    } else if (e.key === '-') {
1110     -      e.preventDefault();
1111     -      zoomOut();
1112     -    } else if (e.key === '0') {
1113     -      e.preventDefault();
1114     -      resetZoom();
    1171 +    // Constrain width
    1172 +    if (newWidth >= minWidth && newWidth <= maxWidth) {
    1173 +      sidebarWidth = newWidth;
    1174 +      fileBrowser.style.width = `${sidebarWidth}px`;
1115 1175      }
1116     -  }
1117     -});
    1176 +  });
1118 1177  
1119     -// Load saved zoom level
1120     -const savedZoom = storageManager.get('previewZoom');
1121     -if (savedZoom) {
1122     -  currentZoom = parseInt(savedZoom, 10);
1123     -  setZoom(currentZoom);
1124     -}
    1178 +  document.addEventListener('mouseup', () => {
    1179 +    if (isResizing) {
    1180 +      isResizing = false;
    1181 +      fileBrowser.classList.remove('resizing');
    1182 +      resizeHandle.classList.remove('dragging');
    1183 +      document.body.style.cursor = '';
    1184 +      document.body.style.userSelect = '';
1125 1185  
1126     -// Load saved view mode
1127     -const savedViewMode = storageManager.get('viewMode') || 'split-view';
1128     -setViewMode(savedViewMode);
    1186 +      // Save width
    1187 +      storageManager.set('sidebarWidth', sidebarWidth.toString());
    1188 +    }
    1189 +  });
1129 1190  
1130     -// ==================== FOLDER BROWSER FUNCTIONALITY ====================
    1191 +  // Open folder handler
    1192 +  openFolderBtn.addEventListener('click', async () => {
    1193 +    if (!folderBrowserService.isSupported()) {
    1194 +      alert(
    1195 +        'Folder browsing requires File System Access API.\n\n' +
    1196 +        'Please use Chrome 86+ or Edge 86+.\n\n' +
    1197 +        'Firefox and Safari are not currently supported.'
    1198 +      );
    1199 +      return;
    1200 +    }
1131 1201  
1132     -// Folder browser DOM elements
1133     -const fileBrowser = document.getElementById('file-browser');
1134     -const openFolderBtn = document.getElementById('open-folder-btn');
1135     -const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
1136     -const closeBrowserBtn = document.getElementById('close-browser-btn');
1137     -const floatingShowBtn = document.getElementById('floating-show-btn');
1138     -const resizeHandle = document.getElementById('resize-handle');
1139     -const fileTree = document.getElementById('file-tree');
1140     -const currentFolderNameEl = document.getElementById('current-folder-name');
1141     -const fileCountEl = document.getElementById('file-count');
    1202 +    const result = await folderBrowserService.openFolder();
1142 1203  
1143     -// Folder browser state (using let to allow reassignment)
1144     -let folderFiles = [];
1145     -let activeFileHandle = null;
1146     -let isResizing = false;
1147     -let sidebarWidth = 280; // Default width
1148     -const minWidth = 100; // Allow squeezing to very narrow
1149     -const maxWidth = 600;
1150     -const collapseThreshold = 80; // Auto-collapse at very left edge only
    1204 +    if (result.cancelled) {
    1205 +      return; // User cancelled
    1206 +    }
1151 1207  
1152     -// Load saved sidebar width
1153     -const savedWidth = storageManager.get('sidebarWidth');
1154     -if (savedWidth) {
1155     -  sidebarWidth = parseInt(savedWidth, 10);
1156     -}
    1208 +    if (!result.success) {
    1209 +      alert('Error opening folder: ' + result.error);
    1210 +      return;
    1211 +    }
1157 1212  
1158     -// Resize functionality
1159     -resizeHandle.addEventListener('mousedown', e => {
1160     -  isResizing = true;
1161     -  fileBrowser.classList.add('resizing');
1162     -  resizeHandle.classList.add('dragging');
1163     -  document.body.style.cursor = 'col-resize';
1164     -  document.body.style.userSelect = 'none';
1165     -  e.preventDefault();
1166     -});
    1213 +    // Store files
    1214 +    folderFiles = result.files;
1167 1215  
1168     -document.addEventListener('mousemove', e => {
1169     -  if (!isResizing) return;
    1216 +    // Show browser sidebar, hide floating button
    1217 +    fileBrowser.style.display = 'flex';
    1218 +    floatingShowBtn.style.display = 'none';
1170 1219  
1171     -  const newWidth = e.clientX;
    1220 +    // Update UI
    1221 +    currentFolderNameEl.textContent = result.folderName;
    1222 +    fileCountEl.textContent = `${result.totalFiles} file${result.totalFiles !== 1 ? 's' : ''}`;
1172 1223  
1173     -  // Check if dragged to leftmost (auto-collapse)
1174     -  if (newWidth < collapseThreshold) {
1175     -    // Auto-collapse with smooth animation
1176     -    fileBrowser.classList.remove('resizing');
    1224 +    // Render tree
    1225 +    renderFileTree(result.files);
    1226 +
    1227 +    console.log(`âœ… Loaded ${result.totalFiles} markdown files from ${result.folderName}`);
    1228 +  });
    1229 +
    1230 +  // Toggle sidebar collapse/expand (keeps folder data)
    1231 +  toggleSidebarBtn.addEventListener('click', () => {
    1232 +    // Hide sidebar, show floating button
1177 1233      fileBrowser.style.display = 'none';
1178 1234      floatingShowBtn.style.display = 'block';
1179     -    isResizing = false;
1180     -    resizeHandle.classList.remove('dragging');
1181     -    document.body.style.cursor = '';
1182     -    document.body.style.userSelect = '';
1183     -    return;
1184     -  }
    1235 +  });
1185 1236  
1186     -  // Constrain width
1187     -  if (newWidth >= minWidth && newWidth <= maxWidth) {
1188     -    sidebarWidth = newWidth;
1189     -    fileBrowser.style.width = `${sidebarWidth}px`;
1190     -  }
1191     -});
    1237 +  // Floating button - show sidebar
    1238 +  floatingShowBtn.addEventListener('click', () => {
    1239 +    // Show sidebar, hide floating button
    1240 +    fileBrowser.style.display = 'flex';
    1241 +    floatingShowBtn.style.display = 'none';
    1242 +  });
1192 1243  
1193     -document.addEventListener('mouseup', () => {
1194     -  if (isResizing) {
1195     -    isResizing = false;
1196     -    fileBrowser.classList.remove('resizing');
1197     -    resizeHandle.classList.remove('dragging');
1198     -    document.body.style.cursor = '';
1199     -    document.body.style.userSelect = '';
    1244 +  // Close browser handler (clears all folder data)
    1245 +  closeBrowserBtn.addEventListener('click', () => {
    1246 +    // Hide everything AND clear data
    1247 +    fileBrowser.style.display = 'none';
    1248 +    floatingShowBtn.style.display = 'none';
    1249 +    folderFiles = [];
    1250 +    activeFileHandle = null;
    1251 +  });
1200 1252  
1201     -    // Save width
1202     -    storageManager.set('sidebarWidth', sidebarWidth.toString());
1203     -  }
1204     -});
    1253 +  // Render file tree
    1254 +  function renderFileTree(items, container = fileTree, indent = 0) {
    1255 +    // Clear container on first render
    1256 +    if (indent === 0) {
    1257 +      container.innerHTML = '';
    1258 +    }
1205 1259  
1206     -// Open folder handler
1207     -openFolderBtn.addEventListener('click', async () => {
1208     -  if (!folderBrowserService.isSupported()) {
1209     -    alert(
1210     -      'Folder browsing requires File System Access API.\n\n' +
1211     -      'Please use Chrome 86+ or Edge 86+.\n\n' +
1212     -      'Firefox and Safari are not currently supported.'
1213     -    );
1214     -    return;
1215     -  }
1216     -
1217     -  const result = await folderBrowserService.openFolder();
1218     -
1219     -  if (result.cancelled) {
1220     -    return; // User cancelled
1221     -  }
1222     -
1223     -  if (!result.success) {
1224     -    alert('Error opening folder: ' + result.error);
1225     -    return;
1226     -  }
1227     -
1228     -  // Store files
1229     -  folderFiles = result.files;
1230     -
1231     -  // Show browser sidebar, hide floating button
1232     -  fileBrowser.style.display = 'flex';
1233     -  floatingShowBtn.style.display = 'none';
1234     -
1235     -  // Update UI
1236     -  currentFolderNameEl.textContent = result.folderName;
1237     -  fileCountEl.textContent = `${result.totalFiles} file${result.totalFiles !== 1 ? 's' : ''}`;
1238     -
1239     -  // Render tree
1240     -  renderFileTree(result.files);
1241     -
1242     -  console.log(`âœ… Loaded ${result.totalFiles} markdown files from ${result.folderName}`);
1243     -});
1244     -
1245     -// Toggle sidebar collapse/expand (keeps folder data)
1246     -toggleSidebarBtn.addEventListener('click', () => {
1247     -  // Hide sidebar, show floating button
1248     -  fileBrowser.style.display = 'none';
1249     -  floatingShowBtn.style.display = 'block';
1250     -});
1251     -
1252     -// Floating button - show sidebar
1253     -floatingShowBtn.addEventListener('click', () => {
1254     -  // Show sidebar, hide floating button
1255     -  fileBrowser.style.display = 'flex';
1256     -  floatingShowBtn.style.display = 'none';
1257     -});
1258     -
1259     -// Close browser handler (clears all folder data)
1260     -closeBrowserBtn.addEventListener('click', () => {
1261     -  // Hide everything AND clear data
1262     -  fileBrowser.style.display = 'none';
1263     -  floatingShowBtn.style.display = 'none';
1264     -  folderFiles = [];
1265     -  activeFileHandle = null;
1266     -});
1267     -
1268     -// Render file tree
1269     -function renderFileTree(items, container = fileTree, indent = 0) {
1270     -  // Clear container on first render
1271     -  if (indent === 0) {
1272     -    container.innerHTML = '';
1273     -  }
1274     -
1275     -  if (items.length === 0 && indent === 0) {
1276     -    container.innerHTML = `
    1260 +    if (items.length === 0 && indent === 0) {
    1261 +      container.innerHTML = `
1277 1262          <div class="empty-state">
1278 1263            <p>ðŸ“‚ No markdown files found</p>
1279 1264            <p class="hint">This folder doesn't contain any .md files</p>
1280 1265          </div>
1281 1266        `;
1282     -    return;
1283     -  }
1284     -
1285     -  items.forEach(item => {
1286     -    if (item.type === 'directory') {
1287     -      const folderDiv = createFolderElement(item, indent);
1288     -      container.appendChild(folderDiv);
1289     -
1290     -      if (item.expanded && item.children) {
1291     -        const childContainer = document.createElement('div');
1292     -        childContainer.className = 'tree-children';
1293     -        renderFileTree(item.children, childContainer, indent + 1);
1294     -        container.appendChild(childContainer);
1295     -      }
1296     -    } else if (item.type === 'file') {
1297     -      const fileDiv = createFileElement(item, indent);
1298     -      container.appendChild(fileDiv);
    1267 +      return;
1299 1268      }
1300     -  });
1301     -}
1302 1269  
1303     -// Create folder element
1304     -function createFolderElement(item, indent) {
1305     -  const div = document.createElement('div');
1306     -  div.className = 'tree-item folder';
1307     -  div.style.paddingLeft = indent * 20 + 12 + 'px';
    1270 +    items.forEach(item => {
    1271 +      if (item.type === 'directory') {
    1272 +        const folderDiv = createFolderElement(item, indent);
    1273 +        container.appendChild(folderDiv);
1308 1274  
1309     -  const icon = item.expanded ? 'ðŸ“‚' : 'ðŸ“';
1310     -  const folderIcon = document.createElement('span');
1311     -  folderIcon.className = 'folder-icon';
1312     -  folderIcon.textContent = icon;
1313     -
1314     -  const folderName = document.createElement('span');
1315     -  folderName.className = 'folder-name';
1316     -  folderName.textContent = item.name;
1317     -
1318     -  const fileCount = document.createElement('span');
1319     -  fileCount.className = 'file-count';
1320     -  fileCount.textContent = item.fileCount;
1321     -
1322     -  div.appendChild(folderIcon);
1323     -  div.appendChild(folderName);
1324     -  div.appendChild(fileCount);
1325     -
1326     -  div.addEventListener('click', e => {
1327     -    e.stopPropagation();
1328     -    toggleFolder(item);
1329     -  });
1330     -
1331     -  return div;
1332     -}
1333     -
1334     -// Create file element
1335     -function createFileElement(item, indent) {
1336     -  const div = document.createElement('div');
1337     -  div.className = 'tree-item file';
1338     -  div.style.paddingLeft = indent * 20 + 12 + 'px';
1339     -
1340     -  // Mark as active if this is the current file
1341     -  if (activeFileHandle === item.handle) {
1342     -    div.classList.add('active');
    1275 +        if (item.expanded && item.children) {
    1276 +          const childContainer = document.createElement('div');
    1277 +          childContainer.className = 'tree-children';
    1278 +          renderFileTree(item.children, childContainer, indent + 1);
    1279 +          container.appendChild(childContainer);
    1280 +        }
    1281 +      } else if (item.type === 'file') {
    1282 +        const fileDiv = createFileElement(item, indent);
    1283 +        container.appendChild(fileDiv);
    1284 +      }
    1285 +    });
1343 1286    }
1344 1287  
1345     -  const fileIcon = document.createElement('span');
1346     -  fileIcon.className = 'file-icon';
1347     -  fileIcon.textContent = 'ðŸ“„';
    1288 +  // Create folder element
    1289 +  function createFolderElement(item, indent) {
    1290 +    const div = document.createElement('div');
    1291 +    div.className = 'tree-item folder';
    1292 +    div.style.paddingLeft = indent * 20 + 12 + 'px';
1348 1293  
1349     -  const fileName = document.createElement('span');
1350     -  fileName.className = 'file-name';
1351     -  fileName.textContent = item.name;
    1294 +    const icon = item.expanded ? 'ðŸ“‚' : 'ðŸ“';
    1295 +    const folderIcon = document.createElement('span');
    1296 +    folderIcon.className = 'folder-icon';
    1297 +    folderIcon.textContent = icon;
1352 1298  
1353     -  div.appendChild(fileIcon);
1354     -  div.appendChild(fileName);
    1299 +    const folderName = document.createElement('span');
    1300 +    folderName.className = 'folder-name';
    1301 +    folderName.textContent = item.name;
1355 1302  
1356     -  div.addEventListener('click', async e => {
1357     -    e.stopPropagation();
1358     -    await loadFileFromBrowser(item);
1359     -  });
    1303 +    const fileCount = document.createElement('span');
    1304 +    fileCount.className = 'file-count';
    1305 +    fileCount.textContent = item.fileCount;
1360 1306  
1361     -  return div;
1362     -}
    1307 +    div.appendChild(folderIcon);
    1308 +    div.appendChild(folderName);
    1309 +    div.appendChild(fileCount);
1363 1310  
1364     -// Toggle folder expand/collapse
1365     -function toggleFolder(folder) {
1366     -  folder.expanded = !folder.expanded;
1367     -  renderFileTree(folderFiles);
1368     -}
    1311 +    div.addEventListener('click', e => {
    1312 +      e.stopPropagation();
    1313 +      toggleFolder(item);
    1314 +    });
1369 1315  
1370     -// Load file from browser
1371     -async function loadFileFromBrowser(fileItem) {
1372     -  const result = await folderBrowserService.readFile(fileItem.handle);
1373     -
1374     -  if (!result.success) {
1375     -    alert('Error loading file: ' + result.error);
1376     -    return;
    1316 +    return div;
1377 1317    }
1378 1318  
1379     -  // Load content into editor
1380     -  editor.value = result.content;
    1319 +  // Create file element
    1320 +  function createFileElement(item, indent) {
    1321 +    const div = document.createElement('div');
    1322 +    div.className = 'tree-item file';
    1323 +    div.style.paddingLeft = indent * 20 + 12 + 'px';
1381 1324  
1382     -  // Mark as active file
1383     -  activeFileHandle = fileItem.handle;
    1325 +    // Mark as active if this is the current file
    1326 +    if (activeFileHandle === item.handle) {
    1327 +      div.classList.add('active');
    1328 +    }
1384 1329  
1385     -  // Re-render tree to update active state
1386     -  renderFileTree(folderFiles);
    1330 +    const fileIcon = document.createElement('span');
    1331 +    fileIcon.className = 'file-icon';
    1332 +    fileIcon.textContent = 'ðŸ“„';
1387 1333  
1388     -  // Render markdown
1389     -  renderMarkdown();
    1334 +    const fileName = document.createElement('span');
    1335 +    fileName.className = 'file-name';
    1336 +    fileName.textContent = item.name;
1390 1337  
1391     -  console.log(`âœ… Loaded file: ${fileItem.name} (${result.size} bytes)`);
1392     -}
    1338 +    div.appendChild(fileIcon);
    1339 +    div.appendChild(fileName);
1393 1340  
1394     -// Expose renderMarkdown globally for theme changes
1395     -globalRenderMarkdown = renderMarkdown;
    1341 +    div.addEventListener('click', async e => {
    1342 +      e.stopPropagation();
    1343 +      await loadFileFromBrowser(item);
    1344 +    });
    1345 +
    1346 +    return div;
    1347 +  }
    1348 +
    1349 +  // Toggle folder expand/collapse
    1350 +  function toggleFolder(folder) {
    1351 +    folder.expanded = !folder.expanded;
    1352 +    renderFileTree(folderFiles);
    1353 +  }
    1354 +
    1355 +  // Load file from browser
    1356 +  async function loadFileFromBrowser(fileItem) {
    1357 +    const result = await folderBrowserService.readFile(fileItem.handle);
    1358 +
    1359 +    if (!result.success) {
    1360 +      alert('Error loading file: ' + result.error);
    1361 +      return;
    1362 +    }
    1363 +
    1364 +    // Load content into editor
    1365 +    editor.value = result.content;
    1366 +
    1367 +    // Mark as active file
    1368 +    activeFileHandle = fileItem.handle;
    1369 +
    1370 +    // Re-render tree to update active state
    1371 +    renderFileTree(folderFiles);
    1372 +
    1373 +    // Render markdown
    1374 +    renderMarkdown();
    1375 +
    1376 +    console.log(`âœ… Loaded file: ${fileItem.name} (${result.size} bytes)`);
    1377 +  }
    1378 +
    1379 +  // Expose renderMarkdown globally for theme changes
    1380 +  globalRenderMarkdown = renderMarkdown;
1396 1381  
1397 1382    // DON'T render immediately - wait for theme to load
1398 1383    // renderMarkdown will be called after theme loads above
1399 1384  

```

---

## ðŸ¤– AI Review Checklist

Please review these changes for:

### ðŸ” Code Quality
- [ ] **Linting Compliance**: No unused imports/variables, proper formatting
- [ ] **Type Safety**: Proper typing throughout (TypeScript/Python type hints)
- [ ] **Best Practices**: Framework-specific conventions and patterns
- [ ] **Performance**: Efficient algorithms, proper memoization
- [ ] **Documentation**: Clear comments and function descriptions

### ðŸ› Potential Issues
- [ ] **Runtime Errors**: Type mismatches, null/undefined handling
- [ ] **Logic Bugs**: Incorrect calculations, edge cases
- [ ] **Memory Leaks**: Cleanup in lifecycle methods, event listeners
- [ ] **Error Handling**: Proper try-catch blocks, user feedback
- [ ] **Accessibility**: ARIA labels, keyboard navigation, screen readers

### ðŸ”’ Security & Data
- [ ] **Input Validation**: Sanitization, XSS prevention, SQL injection
- [ ] **Authentication**: Proper access controls and permissions
- [ ] **Privacy**: No sensitive data exposure in logs/client
- [ ] **Dependencies**: Updated packages, vulnerability checks

### ðŸ“± UX/UI
- [ ] **Responsive Design**: Mobile/desktop/tablet compatibility
- [ ] **Loading States**: Proper feedback during async operations
- [ ] **Error Messages**: User-friendly error handling and recovery
- [ ] **Performance**: Fast loading, smooth animations

### ðŸ’¡ Suggestions & Improvements
Please provide specific feedback on:
1. Code organization and structure improvements
2. Performance optimization opportunities
3. Security considerations and hardening
4. Testing coverage and strategies
5. Documentation and maintainability

---
*Generated by AI Visual Code Review v2.0 - Unified Export Script*
*Files processed: 1/1 | Errors: 0 | Generated: 2025-12-09T01:35:49.634Z*
